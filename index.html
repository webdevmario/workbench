<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workbench</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0b' width='100' height='100' rx='20'/><circle cx='50' cy='50' r='12' fill='%2300d4aa'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0b;
      --surface: #131316;
      --surface-hover: #1a1a1f;
      --border: #2a2a30;
      --text: #e8e8ed;
      --text-muted: #8888a0;
      --accent: #00d4aa;
      --accent-dim: rgba(0, 212, 170, 0.15);
      --danger: #ff5c5c;
      --danger-dim: rgba(255, 92, 92, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html {
      overflow-y: scroll; /* Always show scrollbar to prevent layout shift */
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 40px;
    }

    /* Custom scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .container { max-width: 900px; margin: 0 auto; }

    /* ── Header ── */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      font-weight: 600;
      font-size: 1.25rem;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
    }

    .brand-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    /* ── App Switcher ── */
    .app-nav-container {
      display: flex;
      justify-content: center;
      margin-bottom: 28px;
    }

    .app-nav {
      display: flex;
      gap: 4px;
      background: var(--surface);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .app-tab {
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      padding: 10px 24px;
      border-radius: 7px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      transition: all 0.2s ease;
      width: 140px;
      text-align: center;
      position: relative;
    }

    /* Divider between tabs */
    .app-tab:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -2px;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 1px;
      background: var(--border);
      transition: opacity 0.2s ease;
    }

    /* Hide divider next to active tab or hidden tabs */
    .app-tab.active::after,
    .app-tab:has(+ .app-tab.active)::after,
    .app-tab[style*="display: none"]::after,
    .app-tab:has(+ .app-tab[style*="display: none"]:last-child)::after {
      opacity: 0;
    }

    .app-tab:hover { color: var(--text); }

    .app-tab.active {
      background: var(--accent);
      color: var(--bg);
    }

    .app-view { display: none; }
    .app-view.active { display: block; }

    /* ── Shared Components ── */
    .btn {
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--surface);
      color: var(--text);
    }

    .btn-accent {
      background: var(--accent);
      color: var(--bg);
    }

    .btn-accent:hover { filter: brightness(1.1); }

    .btn-sm {
      padding: 7px 14px;
      font-size: 0.8rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      font-family: inherit;
      font-size: 1rem;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s ease;
      resize: vertical;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: var(--accent);
    }

    .input-group input::placeholder,
    .input-group textarea::placeholder {
      color: var(--text-muted);
    }

    /* Date and time input styling for dark theme */
    .input-group input[type="date"],
    .input-group input[type="time"] {
      color-scheme: dark;
    }

    .input-group input[type="date"]::-webkit-calendar-picker-indicator,
    .input-group input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
      cursor: pointer;
    }

    .input-group select { 
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237a7a85' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      border-color: var(--text-muted);
      color: var(--text);
    }

    .modal {
      position: relative;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-icon.danger:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-icon.resume:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* ── Date Navigation ── */
    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .date-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .date-nav button {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .date-nav button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .date-nav span {
      font-weight: 500;
      min-width: 180px;
      text-align: center;
    }

    .btn-today {
      width: auto !important;
      height: auto !important;
      margin-left: 4px;
      padding: 5px 12px !important;
      font-family: inherit;
      font-size: 0.75rem !important;
      font-weight: 500;
      border-color: var(--accent) !important;
      color: var(--accent) !important;
      white-space: nowrap;
    }

    .btn-today:hover {
      background: var(--accent-dim) !important;
    }

    /* ── Date Picker Popover ── */
    .date-picker-trigger {
      position: relative;
    }

    .date-label-clickable {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .date-label-clickable:hover {
      background: var(--surface-hover);
      color: var(--accent);
    }

    .date-picker-popover {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      z-index: 90;
      box-shadow: 0 12px 40px rgba(0,0,0,0.5);
      width: 280px;
    }

    .date-picker-popover.active { display: block; }

    .date-picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .date-picker-header span {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .date-picker-header button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .date-picker-header button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .date-picker-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .date-picker-grid .dp-day-header {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: center;
      padding: 4px 0;
      font-weight: 500;
    }

    .date-picker-grid .dp-day {
      text-align: center;
      padding: 5px 0;
      font-size: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s ease;
      position: relative;
    }

    .date-picker-grid .dp-day:hover:not(.dp-other-month) {
      background: var(--surface-hover);
      color: var(--text);
    }

    .date-picker-grid .dp-day.dp-other-month {
      opacity: 0.25;
      cursor: default;
    }

    .date-picker-grid .dp-day.dp-today {
      color: var(--accent);
      font-weight: 600;
    }

    .date-picker-grid .dp-day.dp-selected {
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
    }

    .date-picker-grid .dp-day.dp-has-content::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent);
    }

    .date-picker-grid .dp-day.dp-selected.dp-has-content::after {
      background: var(--bg);
    }

    .date-picker-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 89;
    }

    .date-picker-backdrop.active { display: block; }

    .daily-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 480px;
    }

    .modal h3 {
      font-weight: 500;
      margin-bottom: 24px;
    }

    .modal .input-group { margin-bottom: 16px; }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin: 24px -32px -32px -32px;
      padding: 16px 32px;
      border-top: 1px solid var(--border);
    }

    /* ════════════════════════════════
       TIME TRACKER
       ════════════════════════════════ */
    .timer-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 48px;
    }

    .timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 4rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 32px;
      letter-spacing: -0.02em;
      color: var(--accent);
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }

    .timer-display.active {
      opacity: 1;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 200px;
      gap: 16px;
      margin-bottom: 24px;
    }

    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .btn-start {
      background: var(--accent);
      color: var(--bg);
      font-size: 1rem;
      padding: 16px 48px;
      border-radius: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 212, 170, 0.3);
    }

    .btn-stop {
      background: var(--danger);
      color: white;
      font-size: 1rem;
      padding: 16px 48px;
      border-radius: 12px;
      font-weight: 600;
    }

    .btn-stop:hover { filter: brightness(1.1); }

    .total-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      color: var(--accent);
      background: var(--accent-dim);
      padding: 8px 16px;
      border-radius: 20px;
    }

    .entries-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .entry {
      display: grid;
      grid-template-columns: 165px 1fr 80px auto;
      gap: 20px;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 24px;
      transition: all 0.2s ease;
    }

    .entry:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }

    .entry-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .entry-details { display: flex; flex-direction: column; gap: 4px; }
    .entry-description { font-weight: 500; font-size: 1rem; }

    .entry-category {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    .entry-duration {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      text-align: right;
    }

    .entry-actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .entry:hover .entry-actions { opacity: 1; }

    .category-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .category-summary:empty { display: none; }

    .summary-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-card-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .summary-card-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--accent);
    }

    .summary-card-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .summary-card-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .category-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .category-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .category-row input {
      flex: 1;
      font-family: inherit;
      font-size: 0.875rem;
      padding: 9px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease;
    }

    .category-row input:focus { border-color: var(--accent); }

    .add-category {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .add-category input {
      flex: 1;
      font-family: inherit;
      font-size: 0.875rem;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      outline: none;
    }

    .add-category input:focus { border-color: var(--accent); }

    /* ════════════════════════════════
       TASKS
       ════════════════════════════════ */
    .task-input-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 32px;
    }

    .task-filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .task-filters {
      display: flex;
      gap: 4px;
      background: var(--surface);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .task-filter-btn {
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      padding: 7px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      transition: all 0.15s ease;
    }

    .task-filter-btn:hover { color: var(--text); }

    .task-filter-btn.active {
      background: var(--accent);
      color: var(--bg);
    }

    .task-input-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .task-input-row .input-group { flex: 1; }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-item {
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 16px;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      transition: background 0.2s ease, border-color 0.2s ease, opacity 0.2s ease, transform 0.15s ease;
    }

    .task-item:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }

    .task-item.dragging {
      opacity: 0.4;
      transform: scale(0.98);
    }

    .task-item.drag-over {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .task-date-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 4px;
      font-family: 'JetBrains Mono', monospace;
    }

    .task-date-meta .completed-label {
      color: var(--accent);
    }

    .drag-handle {
      cursor: grab;
      color: var(--border);
      display: flex;
      align-items: center;
      padding: 2px;
      border-radius: 4px;
      transition: color 0.15s ease;
    }

    .drag-handle:active { cursor: grabbing; }
    .drag-handle:hover { color: var(--text-muted); }

    .task-item.done .drag-handle { opacity: 0.3; }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      transition: all 0.15s ease;
      flex-shrink: 0;
      color: transparent;
    }

    .task-checkbox:hover { border-color: var(--accent); }

    .task-checkbox.checked {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .task-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .task-title {
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .task-item.done .task-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-notes {
      font-size: 0.875rem;
      color: var(--text-muted);
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .task-item.done .task-notes { opacity: 0.5; }

    /* Task completion animation */
    .task-item.completing {
      animation: taskComplete 0.6s ease forwards;
    }

    @keyframes taskComplete {
      0% { 
        transform: scale(1);
        opacity: 1;
      }
      15% {
        transform: scale(1.02);
      }
      40% {
        opacity: 1;
        transform: scale(1);
      }
      100% { 
        opacity: 0.6;
        transform: translateX(8px);
      }
    }

    /* Celebration burst */
    .celebration {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      pointer-events: none;
    }

    .celebration-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: celebrationPop 0.8s ease forwards;
    }

    @keyframes celebrationPop {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      20% {
        transform: scale(1.2);
        opacity: 1;
      }
      40% {
        transform: scale(0.95);
      }
      60% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(0.8);
        opacity: 0;
      }
    }

    .celebration-check {
      width: 72px;
      height: 72px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 40px rgba(0, 212, 170, 0.5);
    }

    .celebration-check svg {
      width: 36px;
      height: 36px;
      stroke: var(--bg);
      stroke-width: 3;
      fill: none;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkDraw 0.4s ease 0.15s forwards;
    }

    @keyframes checkDraw {
      to {
        stroke-dashoffset: 0;
      }
    }

    .celebration-text {
      font-weight: 600;
      font-size: 1rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Confetti particles */
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .confetti:nth-child(1) { background: var(--accent); animation: confetti1 0.8s ease forwards; }
    .confetti:nth-child(2) { background: #f0c040; animation: confetti2 0.8s ease forwards; }
    .confetti:nth-child(3) { background: #ff6b9d; animation: confetti3 0.8s ease forwards; }
    .confetti:nth-child(4) { background: #a78bfa; animation: confetti4 0.8s ease forwards; }
    .confetti:nth-child(5) { background: #60a5fa; animation: confetti5 0.8s ease forwards; }
    .confetti:nth-child(6) { background: var(--accent); animation: confetti6 0.8s ease forwards; }

    @keyframes confetti1 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(-60px, -80px) rotate(200deg); opacity: 0; } }
    @keyframes confetti2 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(70px, -70px) rotate(-180deg); opacity: 0; } }
    @keyframes confetti3 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(-50px, 60px) rotate(160deg); opacity: 0; } }
    @keyframes confetti4 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(60px, 50px) rotate(-200deg); opacity: 0; } }
    @keyframes confetti5 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(-80px, 20px) rotate(180deg); opacity: 0; } }
    @keyframes confetti6 { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(80px, -30px) rotate(-160deg); opacity: 0; } }

    .task-actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
      flex-shrink: 0;
    }

    .task-item:hover .task-actions { opacity: 1; }

    .task-stats {
      font-size: 0.875rem;
      color: var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 20px;
    }

    .task-stats strong {
      color: var(--accent);
      font-weight: 600;
    }

    .carryover-banner {
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .carryover-banner p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .carryover-banner strong {
      color: var(--text);
    }

    .btn-carryover {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 8px 16px;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .btn-carryover:hover {
      background: var(--accent);
      color: var(--bg);
    }

    /* ════════════════════════════════
       NOTES
       ════════════════════════════════ */
    .notes-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .notes-count {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .notes-count strong {
      color: var(--text);
      font-weight: 600;
    }

    .notes-count-sep {
      margin: 0 6px;
      opacity: 0.3;
    }

    .notes-count-detail {
      opacity: 0.6;
      font-size: 0.8rem;
    }

    .notes-header-actions {
      display: flex;
      gap: 8px;
    }

    .notes-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .note-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .note-card:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }

    .note-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .note-card-date {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 500;
    }

    .note-card-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .note-card:hover .note-card-actions { opacity: 1; }

    .note-card-preview {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.6;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .note-card-words {
      font-size: 0.7rem;
      color: var(--text-muted);
      opacity: 0.5;
      margin-top: 8px;
    }

    .notes-show-more {
      width: 100%;
      padding: 16px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      border: 1px dashed var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .notes-show-more:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .notes-remaining-count {
      font-size: 0.7rem;
      opacity: 0.5;
    }

    .note-editor-modal {
      max-width: 600px;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }

    .note-toolbar-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .note-toolbar-row .notes-toolbar {
      margin-bottom: 0;
    }

    .notes-toolbar {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 12px;
    }

    .toolbar-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .notes-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .notes-meta .word-count { opacity: 0.5; }
    .notes-meta .save-status { transition: color 0.2s ease; }
    .notes-meta .save-status.saved { color: var(--accent); }

    .notes-container {
      position: relative;
      flex: 1;
      min-height: 0;
    }

    .notes-editor {
      width: 100%;
      min-height: 280px;
      max-height: 50vh;
      padding: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.8;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      outline: none;
      resize: none;
      overflow-y: auto;
      transition: border-color 0.2s ease;
    }

    .notes-editor:focus { border-color: var(--accent); }
    .notes-editor::placeholder { color: var(--text-muted); opacity: 0.5; }

    /* ════════════════════════════════
       SEARCH (Spotlight style)
       ════════════════════════════════ */
    .search-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
      backdrop-filter: blur(4px);
    }

    .search-modal-overlay.active { display: flex; }

    .search-modal {
      width: 100%;
      max-width: 540px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      overflow: hidden;
    }

    .search-modal-input-wrap {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .search-modal-input-wrap svg {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .search-modal-input {
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 400;
      background: none;
      border: none;
      color: var(--text);
      outline: none;
      width: 100%;
    }

    .search-modal-input::placeholder { color: var(--text-muted); opacity: 0.6; }

    .search-modal-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      opacity: 0.5;
      flex-shrink: 0;
    }

    .search-modal-hint kbd {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      color: var(--text-muted);
    }

    .search-modal-results {
      max-height: 360px;
      overflow-y: auto;
    }

    .search-modal-results:empty { display: none; }

    .search-result-item {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover,
    .search-result-item.active { background: var(--accent-dim); }

    .search-result-type {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .search-result-title {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .search-result-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-empty {
      padding: 32px 24px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .search-initial {
      padding: 32px 24px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      opacity: 0.5;
    }

    /* ════════════════════════════════
       TOAST NOTIFICATIONS
       ════════════════════════════════ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 0.85rem;
      color: var(--text);
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      animation: toastIn 0.25s ease, toastOut 0.25s ease 2.75s forwards;
      max-width: 360px;
    }

    .toast.toast-error {
      border-color: var(--danger);
      color: var(--danger);
    }

    .toast.toast-success {
      border-color: var(--accent);
      color: var(--accent);
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(12px); }
    }

    /* ════════════════════════════════
       CONFIRM DIALOG
       ════════════════════════════════ */
    .confirm-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 250;
      align-items: center;
      justify-content: center;
    }

    .confirm-overlay.active { display: flex; }

    .confirm-dialog {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px 32px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .confirm-dialog h4 {
      font-weight: 500;
      margin-bottom: 8px;
    }

    .confirm-dialog p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .confirm-actions .btn {
      min-width: 100px;
    }

    /* ════════════════════════════════
       KEYBOARD SHORTCUTS
       ════════════════════════════════ */
    .shortcuts-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .shortcut-row:last-child { border-bottom: none; }

    .shortcut-label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .shortcut-keys {
      display: flex;
      gap: 4px;
    }

    kbd {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 3px 7px;
      color: var(--text);
      min-width: 24px;
      text-align: center;
    }

    /* ════════════════════════════════
       STATS MODAL
       ════════════════════════════════ */
    .stats-modal {
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .stats-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stats-header h3 {
      margin: 0;
    }

    .stats-period {
      display: flex;
      gap: 4px;
      background: var(--bg);
      border-radius: 6px;
      padding: 3px;
    }

    .stats-period button {
      font-family: inherit;
      font-size: 0.75rem;
      padding: 6px 0;
      width: 70px;
      text-align: center;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .stats-period button.active {
      background: var(--surface);
      color: var(--text);
    }

    .stats-period button:hover:not(.active) {
      color: var(--text);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .stats-section {
      margin-bottom: 28px;
    }

    .stats-section:last-child {
      margin-bottom: 0;
    }

    .stats-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .stats-bar-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .stats-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stats-bar-label {
      width: 140px;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stats-bar-track {
      flex: 1;
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
    }

    .stats-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    .stats-bar-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
      width: 60px;
      text-align: right;
    }

    .stats-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .stats-percentage-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stats-percentage-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-percentage-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: var(--accent-dim);
      border-radius: 8px;
      z-index: 0;
    }

    .stats-percentage-label {
      position: relative;
      z-index: 1;
      font-size: 0.85rem;
    }

    .stats-percentage-value {
      position: relative;
      z-index: 1;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--accent);
    }

    .stats-activity {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
    }

    .activity-day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background: var(--bg);
    }

    .activity-day.level-1 { background: rgba(0, 212, 170, 0.25); }
    .activity-day.level-2 { background: rgba(0, 212, 170, 0.5); }
    .activity-day.level-3 { background: rgba(0, 212, 170, 0.75); }
    .activity-day.level-4 { background: var(--accent); }

    /* ════════════════════════════════
       SETTINGS MODAL
       ════════════════════════════════ */
    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .settings-buttons {
      display: flex;
      gap: 12px;
    }

    .settings-buttons .btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 20px;
    }

    .settings-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 12px;
      opacity: 0.7;
    }

    .holiday-import-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .holiday-import-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .holiday-import-actions {
      display: flex;
      gap: 8px;
    }

    .holiday-import-actions .btn {
      flex: 1;
    }

    .settings-danger {
      background: rgba(239, 68, 68, 0.05);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 8px;
    }

    .settings-danger .settings-section-title {
      color: #f87171;
    }

    .settings-danger-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .btn-danger {
      background: transparent;
      border: 1px solid #ef4444;
      color: #f87171;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Settings Tabs */
    .settings-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin: -8px -32px 24px -32px;
      padding: 0 32px;
    }

    .settings-tab {
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      padding: 12px 16px;
      border: none;
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .settings-tab:hover { color: var(--text); }

    .settings-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Settings fixed-height modal */
    .settings-modal-fixed {
      max-width: 520px;
      height: 560px;
      display: flex;
      flex-direction: column;
    }

    .settings-modal-fixed h3 {
      flex-shrink: 0;
    }

    .settings-modal-fixed .settings-tabs {
      flex-shrink: 0;
    }

    .settings-body {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      padding-bottom: 8px;
    }

    .settings-panel {
      display: none;
    }

    .settings-panel.active {
      display: block;
    }

    .settings-modal-fixed > .modal-actions {
      flex-shrink: 0;
      margin-top: auto;
    }

    /* Feature Toggles */
    .feature-toggles {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .feature-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }

    .feature-toggle:last-child {
      border-bottom: none;
    }

    .feature-toggle-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      font-weight: 450;
      color: var(--text);
    }

    .feature-toggle-info svg {
      color: var(--text-muted);
    }

    .feature-toggle input[type="checkbox"] {
      display: none;
    }

    .toggle-switch {
      position: relative;
      width: 40px;
      height: 22px;
      background: var(--border);
      border-radius: 11px;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      background: var(--text-muted);
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .feature-toggle input:checked + .toggle-switch {
      background: var(--accent-dim);
    }

    .feature-toggle input:checked + .toggle-switch::after {
      left: 21px;
      background: var(--accent);
    }

    /* ════════════════════════════════
       PTO TRACKER
       ════════════════════════════════ */
    .pto-top-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 28px;
    }

    .pto-bottom-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 32px;
    }

    .pto-main {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .pto-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .pto-stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .pto-stat-card.warning {
      border-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .pto-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .pto-stat-card.warning .pto-stat-value {
      color: #f59e0b;
    }

    .pto-stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .pto-holiday-alert {
      background: linear-gradient(135deg, var(--accent-dim), transparent);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 28px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 8px;
    }

    .pto-holiday-alert:empty {
      display: none;
    }

    .pto-holiday-alert-icon {
      font-size: 1.75rem;
      margin-bottom: 2px;
    }

    .pto-holiday-alert-title {
      font-weight: 600;
      font-size: 1.15rem;
    }

    .pto-holiday-alert-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .pto-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .pto-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .pto-section-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .pto-calendar-container {
      margin-bottom: 20px;
    }

    .pto-calendar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 16px;
    }

    .pto-calendar-header span {
      font-weight: 500;
      min-width: 150px;
      text-align: center;
    }

    .pto-calendar-header button {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s ease;
    }

    .pto-calendar-header button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .pto-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .pto-calendar-day-header {
      text-align: center;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .pto-calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .pto-calendar-day:hover:not(.other-month):not(.holiday):not(.used) {
      background: var(--bg);
      border-color: var(--border);
    }

    .pto-calendar-day.other-month {
      color: var(--text-muted);
      opacity: 0.3;
      cursor: default;
    }

    .pto-calendar-day.today {
      border-color: var(--accent);
    }

    .pto-calendar-day.selected {
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
    }

    .pto-calendar-day.holiday {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      cursor: default;
    }

    .pto-calendar-day.used {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      cursor: default;
      text-decoration: line-through;
    }

    .pto-calendar-day.weekend {
      color: var(--text-muted);
      opacity: 0.5;
      cursor: default;
    }

    .pto-selected {
      min-height: 40px;
    }

    .pto-selected-days {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pto-selected-day {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
    }

    .pto-selected-day button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
      opacity: 0.7;
    }

    .pto-selected-day button:hover {
      opacity: 1;
    }

    .pto-email-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .pto-email-section textarea {
      font-family: inherit;
      font-size: 0.9rem;
    }

    .pto-email-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .pto-confirm-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed var(--border);
    }

    .pto-confirm-section p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .pto-history {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pto-history-empty {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
    }

    .pto-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg);
      border-radius: 8px;
    }

    .pto-history-date {
      font-weight: 500;
    }

    .pto-history-type {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      background: var(--surface);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .pto-history-actions {
      display: flex;
      gap: 8px;
    }

    .pto-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .pto-sidebar-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .pto-sidebar-section h4 {
      margin: 0 0 16px 0;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .pto-holidays {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
    }

    .pto-holiday-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .pto-holiday-item.past {
      opacity: 0.4;
    }

    .pto-holiday-item:hover {
      opacity: 1;
    }

    .pto-holiday-item.next {
      border: 1px solid var(--accent);
      background: var(--accent-dim);
    }

    .pto-holiday-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
      overflow: hidden;
    }

    .pto-holiday-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pto-holiday-date {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .pto-holiday-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s ease;
      flex-shrink: 0;
    }

    .pto-holiday-item:hover .pto-holiday-actions {
      opacity: 1;
    }

    /* Edit Holidays Modal */
    .edit-holidays-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      flex: 1;
      max-height: 450px;
      margin-bottom: 16px;
    }

    .edit-holiday-row {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .edit-holiday-row input {
      font-family: inherit;
      font-size: 0.82rem;
      padding: 6px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      outline: none;
      color-scheme: dark;
    }

    .edit-holiday-row input:focus {
      border-color: var(--accent);
    }

    .edit-holiday-row input[type="date"] {
      width: 130px;
    }

    .edit-holiday-row input[type="text"].edit-holiday-note {
      width: 80px;
    }

    .edit-holiday-row .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
    }

    /* Tooltip */
    .tooltip-trigger {
      position: relative;
      display: inline-flex;
      align-items: center;
      cursor: help;
    }

    .tooltip-content {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.75rem;
      font-weight: 400;
      letter-spacing: 0;
      text-transform: none;
      color: var(--text-muted);
      white-space: normal;
      width: 260px;
      z-index: 10;
      line-height: 1.5;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .tooltip-content.tooltip-format {
      width: 280px;
      padding: 14px 16px;
    }

    .tooltip-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      line-height: 1.6;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
    }

    .tooltip-trigger:hover .tooltip-content,
    .tooltip-trigger:focus .tooltip-content {
      display: block;
    }

    .pto-nudge {
      margin-top: 16px;
      padding: 12px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px dashed #fbbf24;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fbbf24;
      text-align: center;
    }

    .pto-empty-state {
      text-align: center;
      padding: 48px 24px;
    }

    .pto-empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .pto-empty-state-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .pto-empty-state-text {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .pto-setup-prompt {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 48px;
      text-align: center;
      margin-bottom: 24px;
    }

    .pto-setup-prompt-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .pto-setup-prompt h3 {
      margin-bottom: 12px;
    }

    .pto-setup-prompt p {
      color: var(--text-muted);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <span class="brand-dot"></span>
        Workbench
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost btn-sm" onclick="openModal('statsModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>Stats</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('settingsModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>Settings</button>
      </div>
    </header>

    <div class="app-nav-container">
      <nav class="app-nav">
        <button class="app-tab active" onclick="switchApp('timer')">Time Tracker</button>
        <button class="app-tab" onclick="switchApp('tasks')">Tasks</button>
        <button class="app-tab" onclick="switchApp('notes')">Notes</button>
        <button class="app-tab" onclick="switchApp('pto')">PTO</button>
      </nav>
    </div>

    <!-- ══════ TIME TRACKER ══════ -->
    <div id="view-timer" class="app-view active">
      <section class="timer-section">
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="input-row">
          <div class="input-group">
            <label>Description</label>
            <input type="text" id="description" placeholder="What are you working on?">
          </div>
          <div class="input-group">
            <label>Category</label>
            <select id="category"></select>
          </div>
        </div>
        <div class="timer-controls">
          <button class="btn btn-start" id="startBtn" onclick="startTimer()"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="margin-right:8px;vertical-align:-3px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>Start Timer</button>
          <button class="btn btn-stop" id="stopBtn" onclick="stopTimer()" style="display:none;"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="margin-right:8px;vertical-align:-3px;"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>Stop &amp; Save</button>
        </div>
      </section>

      <section class="daily-view">
        <div class="daily-header">
          <div class="date-nav">
            <button onclick="changeTimerDate(-1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
            <div class="date-picker-trigger">
              <span id="timerCurrentDate" class="date-label-clickable" onclick="toggleDatePicker('timer')"></span>
              <div class="date-picker-popover" id="dpTimer"></div>
            </div>
            <button onclick="changeTimerDate(1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
            <button class="btn btn-ghost btn-sm btn-today" id="timerTodayBtn" onclick="goToTimerToday()" style="display:none;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:4px;vertical-align:-1px;"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>Today</button>
          </div>
          <div class="daily-header-right">
            <button class="btn btn-ghost btn-sm" onclick="openModal('addEntryModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Add Entry</button>
            <button class="btn btn-ghost btn-sm" onclick="openModal('categoryModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M4 7h16M4 12h10M4 17h13"/></svg>Categories</button>
            <div class="total-time" id="totalTime">Total: 00:00:00</div>
          </div>
        </div>
        <div class="category-summary" id="categorySummary"></div>
        <div class="entries-list" id="entriesList"></div>
      </section>
    </div>

    <!-- ══════ TASKS ══════ -->
    <div id="view-tasks" class="app-view">
      <section class="task-input-section">
        <div class="input-group">
          <label>Task</label>
          <input type="text" id="taskTitle" placeholder="What needs to get done?">
        </div>
        <div class="input-group" style="margin-top:12px;">
          <label>Notes (optional)</label>
          <textarea id="taskNotes" placeholder="Extra details, links, context..." rows="3"></textarea>
        </div>
        <button class="btn btn-accent" onclick="addTask()" style="width:100%; margin-top:16px; padding:14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:-2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Add Task</button>
      </section>

      <section class="daily-view">
        <div class="task-filter-bar">
          <div class="task-filters">
            <button class="task-filter-btn active" onclick="setTaskFilter('active')" data-filter="active">Active</button>
            <button class="task-filter-btn" onclick="setTaskFilter('all')" data-filter="all">All</button>
            <button class="task-filter-btn" onclick="setTaskFilter('done')" data-filter="done">Completed</button>
          </div>
          <div class="task-stats" id="taskStats"></div>
        </div>
        <div class="task-list" id="taskList"></div>
      </section>
    </div>

    <!-- ══════ NOTES ══════ -->
    <div id="view-notes" class="app-view">
      <section class="notes-list-view" id="notesListView">
        <div class="notes-list-header">
          <div class="notes-count" id="notesCount"></div>
          <div class="notes-header-actions">
            <button class="btn btn-ghost btn-sm" onclick="openSearch()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Search</button>
            <button class="btn btn-accent btn-sm" onclick="openNoteEditor()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Note</button>
          </div>
        </div>
        <div class="notes-cards" id="notesCards"></div>
      </section>

    </div>

    <!-- ══════ PTO ══════ -->
    <div id="view-pto" class="app-view">
      <div id="ptoSetupPrompt" class="pto-setup-prompt" style="display:none;">
        <div class="pto-setup-prompt-icon">📅</div>
        <h3>Set Up PTO Tracking</h3>
        <p>Track your paid time off, see your remaining balance, and generate PTO request emails.</p>
        <button class="btn btn-accent" onclick="openModal('ptoSetupModal')">Get Started</button>
      </div>
      
      <div id="ptoContent" style="display:none;">
        <!-- Top Row: Stats + Holiday Countdown (full width) -->
        <div class="pto-top-section">
          <div class="pto-stats" id="ptoStats"></div>
          <div class="pto-holiday-alert" id="ptoHolidayAlert"></div>
        </div>

        <!-- Bottom: 2-column layout — Calendar | Holidays -->
        <div class="pto-bottom-layout">
          <div class="pto-main">
            <!-- Request Section -->
            <div class="pto-section">
              <div class="pto-section-header">
                <h3>Request Time Off</h3>
                <button class="btn btn-ghost btn-sm" onclick="openModal('ptoSettingsModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>Settings</button>
              </div>
              
              <div class="pto-calendar-container">
                <div class="pto-calendar-header">
                  <button onclick="changePtoMonth(-1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                  <span id="ptoCalendarMonth"></span>
                  <button onclick="changePtoMonth(1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                </div>
                <div class="pto-calendar" id="ptoCalendar"></div>
              </div>

              <div class="pto-selected" id="ptoSelected"></div>
              
              <div class="pto-email-section" id="ptoEmailSection" style="display:none;">
                <div class="input-group">
                  <label>Email Preview</label>
                  <textarea id="ptoEmailPreview" rows="6" readonly></textarea>
                </div>
                <div class="pto-email-actions">
                  <button class="btn btn-ghost" onclick="copyPtoEmail()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy Email</button>
                  <button class="btn btn-accent" onclick="openPtoEmailClient()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Open in Mail</button>
                </div>
                <div class="pto-confirm-section" id="ptoConfirmSection">
                  <p>After sending the email and receiving approval, confirm to log these days:</p>
                  <button class="btn btn-accent" onclick="confirmPtoRequest()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Confirm PTO Sent &amp; Approved</button>
                </div>
              </div>
            </div>

            <!-- PTO History -->
            <div class="pto-section">
              <div class="pto-section-header">
                <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:-2px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2026 PTO History</h3>
                <button class="btn btn-ghost btn-sm" onclick="openModal('ptoManualEntryModal')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Add Past Entry</button>
              </div>
              <div class="pto-history" id="ptoHistory"></div>
            </div>
          </div>

          <!-- Holidays Sidebar -->
          <div class="pto-sidebar">
            <div class="pto-sidebar-section">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:-2px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2026 Holidays</h4>
                <button class="btn-icon" onclick="window._editHolidayIdx=null;document.getElementById('addHolidayDate').value='';document.getElementById('addHolidayName').value='';document.getElementById('addHolidayNote').value='';document.getElementById('addHolidayTitle').textContent='Add Holiday';document.getElementById('addHolidaySaveBtn').textContent='Add Holiday';openModal('addHolidayModal')" title="Add holiday" style="width:28px;height:28px;border-radius:6px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
              </div>
              <div class="pto-holidays" id="ptoHolidays"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date picker backdrop -->
  <div class="date-picker-backdrop" id="dpBackdrop" onclick="closeAllDatePickers()"></div>

  <!-- ══════ SEARCH MODAL ══════ -->
  <div class="search-modal-overlay" id="searchOverlay" onclick="if(event.target===this)closeSearch()">
    <div class="search-modal">
      <div class="search-modal-input-wrap">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-modal-input" id="globalSearch" placeholder="Search notes..." oninput="onSearchInput()" onkeydown="onSearchKeydown(event)" autocomplete="off">
        <span class="search-modal-hint"><kbd>esc</kbd></span>
      </div>
      <div class="search-modal-results" id="searchResults"></div>
    </div>
  </div>

  <!-- ══════ MODALS ══════ -->

  <!-- Note Editor Modal -->
  <div class="modal-overlay" id="noteEditorModal">
    <div class="modal note-editor-modal">
      <button class="modal-close" onclick="closeNoteEditor()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3 id="noteModalTitle">New Note</h3>
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="noteDate" onchange="onNoteDateChange()">
      </div>
      <div class="note-toolbar-row">
        <div class="notes-toolbar">
          <button class="toolbar-btn" onclick="formatBold()" title="Bold (Ctrl+B)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
          </button>
          <button class="toolbar-btn" onclick="formatList()" title="Bullet List">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="12" r="1.5" fill="currentColor"/><circle cx="4" cy="18" r="1.5" fill="currentColor"/></svg>
          </button>
          <button class="toolbar-btn" onclick="formatCode()" title="Code">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          </button>
        </div>
        <div class="notes-meta">
          <span class="word-count" id="wordCount">0 words</span>
          <span class="save-status" id="saveStatus"></span>
        </div>
      </div>
      <div class="notes-container">
        <textarea id="notesEditor" class="notes-editor" placeholder="Start writing..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeNoteEditor()">Done</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('editModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Edit Entry</h3>
      <div class="input-group"><label>Description</label><input type="text" id="editDescription"></div>
      <div class="input-group"><label>Category</label><select id="editCategory"></select></div>
      <div class="input-group"><label>Date</label><input type="date" id="editDate"></div>
      <div class="time-inputs">
        <div class="input-group"><label>Start Time</label><input type="time" id="editStartTime" step="1"></div>
        <div class="input-group"><label>End Time</label><input type="time" id="editEndTime" step="1"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('editModal')">Cancel</button>
        <button class="btn btn-accent" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="addEntryModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('addEntryModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Add Time Entry</h3>
      <div class="input-group"><label>Description</label><input type="text" id="addEntryDescription" placeholder="What did you work on?"></div>
      <div class="input-group"><label>Category</label><select id="addEntryCategory"></select></div>
      <div class="input-group"><label>Date</label><input type="date" id="addEntryDate"></div>
      <div class="time-inputs">
        <div class="input-group"><label>Start Time</label><input type="time" id="addEntryStartTime"></div>
        <div class="input-group"><label>End Time</label><input type="time" id="addEntryEndTime"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('addEntryModal')">Cancel</button>
        <button class="btn btn-accent" onclick="saveNewEntry()">Add Entry</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="categoryModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('categoryModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Manage Categories</h3>
      <div class="category-list" id="categoryList"></div>
      <div class="add-category">
        <input type="text" id="newCategory" placeholder="New category name" onkeydown="if(event.key==='Enter'){event.preventDefault();addCategory();}">
        <button class="btn btn-accent btn-sm" onclick="addCategory()">Add</button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('categoryModal')">Cancel</button>
        <button class="btn btn-accent" onclick="saveCategories()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editTaskModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('editTaskModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Edit Task</h3>
      <div class="input-group"><label>Task</label><input type="text" id="editTaskTitle"></div>
      <div class="input-group"><label>Notes</label><textarea id="editTaskNotes" rows="3"></textarea></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('editTaskModal')">Cancel</button>
        <button class="btn btn-accent" onclick="saveTaskEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="statsModal">
    <div class="modal stats-modal">
      <button class="modal-close" onclick="closeModal('statsModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <div class="stats-header">
        <h3>Stats</h3>
        <div class="stats-period">
          <button class="active" onclick="setStatsPeriod('week')">Week</button>
          <button onclick="setStatsPeriod('month')">Month</button>
          <button onclick="setStatsPeriod('all')">All Time</button>
        </div>
      </div>
      <div id="statsContent"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('statsModal')">Close</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="settingsModal">
    <div class="modal settings-modal-fixed">
      <button class="modal-close" onclick="closeModal('settingsModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Settings</h3>
      <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('features')">Features</button>
        <button class="settings-tab" onclick="switchSettingsTab('data')">Data</button>
        <button class="settings-tab" onclick="switchSettingsTab('shortcuts')">Shortcuts</button>
        <button class="settings-tab" onclick="switchSettingsTab('danger')">Danger Zone</button>
      </div>

      <div class="settings-body">
        <div class="settings-panel active" id="settingsPanel-features">
          <p class="settings-hint" style="margin-top:0;margin-bottom:16px;">Toggle which tools appear in the nav bar. Your data is always preserved.</p>
          <div class="feature-toggles">
            <label class="feature-toggle">
              <span class="feature-toggle-info">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Time Tracker
              </span>
              <input type="checkbox" id="featureTimer" checked onchange="saveFeatureToggles()">
              <span class="toggle-switch"></span>
            </label>
            <label class="feature-toggle">
              <span class="feature-toggle-info">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                Tasks
              </span>
              <input type="checkbox" id="featureTasks" checked onchange="saveFeatureToggles()">
              <span class="toggle-switch"></span>
            </label>
            <label class="feature-toggle">
              <span class="feature-toggle-info">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Notes
              </span>
              <input type="checkbox" id="featureNotes" checked onchange="saveFeatureToggles()">
              <span class="toggle-switch"></span>
            </label>
            <label class="feature-toggle">
              <span class="feature-toggle-info">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                PTO
              </span>
              <input type="checkbox" id="featurePto" checked onchange="saveFeatureToggles()">
              <span class="toggle-switch"></span>
            </label>
          </div>
        </div>

        <div class="settings-panel" id="settingsPanel-data">
          <div class="settings-buttons">
            <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Import Data
            </button>
            <button class="btn btn-ghost" onclick="exportData()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Export Data
            </button>
          </div>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
          <p class="settings-hint">Export creates a backup of all your time entries, tasks, notes, categories, and PTO data.</p>
        </div>

        <div class="settings-panel" id="settingsPanel-shortcuts">
          <div class="shortcuts-grid">
            <div class="shortcut-row"><span class="shortcut-label">Search notes</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>/</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">New task</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>K</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">New note</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>J</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">Switch to Time Tracker</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>1</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">Switch to Tasks</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>2</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">Switch to Notes</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>3</kbd></div></div>
            <div class="shortcut-row"><span class="shortcut-label">Switch to PTO</span><div class="shortcut-keys"><kbd>⌘</kbd><kbd>4</kbd></div></div>
          </div>
          <p class="settings-hint">On Windows/Linux, use Ctrl instead of ⌘</p>
        </div>

        <div class="settings-panel" id="settingsPanel-danger">
          <div class="settings-section settings-danger" style="margin-bottom:0;">
            <p class="settings-danger-text">Permanently delete all your data and start fresh. This cannot be undone.</p>
            <button class="btn btn-danger" onclick="clearAllData()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
              Clear All Data
            </button>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('settingsModal')">Close</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="ptoSettingsModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('ptoSettingsModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>PTO Settings</h3>
      <div class="settings-section">
        <div class="input-group">
          <label>Year Employment Started</label>
          <select id="ptoStartYear"></select>
        </div>
        <div class="input-group">
          <label>Rollover Days from Last Year</label>
          <input type="number" id="ptoRollover" min="0" max="8" value="8">
        </div>
        <div class="input-group">
          <label>Your Initials (for email subject)</label>
          <input type="text" id="ptoInitials" placeholder="e.g., JD" maxlength="5">
        </div>
        <div class="input-group">
          <label>Supervisor Name</label>
          <input type="text" id="ptoSupervisor" placeholder="e.g., Jane">
        </div>
        <div class="input-group">
          <label>Supervisor Email</label>
          <input type="email" id="ptoSupervisorEmail" placeholder="e.g., manager@company.com">
        </div>
        <div class="input-group">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ptoExcludeRollover" checked style="width:auto;">
            <span>Exclude rollover days from percentage calculation</span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title" style="display:flex;align-items:center;gap:8px;">
          Holidays
          <span class="tooltip-trigger" tabindex="0">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="cursor:help;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span class="tooltip-content tooltip-format">
              <div style="margin-bottom:8px;">Import expects a JSON array:</div>
              <div class="tooltip-code">[{<br>&nbsp;&nbsp;"date": "2026-01-01",<br>&nbsp;&nbsp;"name": "New Year's Day",<br>&nbsp;&nbsp;"note": "CLOSED"<br>}]</div>
            </span>
          </span>
        </div>
        <div class="settings-buttons">
          <button class="btn btn-ghost" onclick="document.getElementById('ptoImportFile').click()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Import Holidays
          </button>
          <button class="btn btn-ghost" onclick="exportHolidayData()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Export Holidays
          </button>
        </div>
        <input type="file" id="ptoImportFile" accept=".json" style="display: none;" onchange="importHolidayData(event)">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('ptoSettingsModal')">Cancel</button>
        <button class="btn btn-accent" onclick="savePtoSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="ptoManualEntryModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('ptoManualEntryModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Add Past PTO Entry</h3>
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="ptoManualDate">
      </div>
      <div class="input-group">
        <label>Type</label>
        <select id="ptoManualType">
          <option value="vacation">Vacation</option>
          <option value="sick">Sick</option>
        </select>
      </div>
      <div class="input-group">
        <label>Notes (optional)</label>
        <input type="text" id="ptoManualNotes" placeholder="e.g., Doctor appointment">
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('ptoManualEntryModal')">Cancel</button>
        <button class="btn btn-accent" onclick="addManualPtoEntry()">Add Entry</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="addHolidayModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('addHolidayModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3 id="addHolidayTitle">Add Holiday</h3>
      <div class="input-group"><label>Date</label><input type="date" id="addHolidayDate"></div>
      <div class="input-group"><label>Name</label><input type="text" id="addHolidayName" placeholder="e.g., Memorial Day"></div>
      <div class="input-group"><label>Note (optional)</label><input type="text" id="addHolidayNote" placeholder="e.g., CLOSED"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('addHolidayModal')">Cancel</button>
        <button class="btn btn-accent" id="addHolidaySaveBtn" onclick="saveNewHoliday()">Add Holiday</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editHolidaysModal">
    <div class="modal" style="max-width:600px;max-height:85vh;display:flex;flex-direction:column;">
      <button class="modal-close" onclick="closeModal('editHolidaysModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Edit Holidays</h3>
      <div class="edit-holidays-list" id="editHolidaysList"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('editHolidaysModal')">Cancel</button>
        <button class="btn btn-accent" onclick="saveAllHolidayEdits()">Save All</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="ptoSetupModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('ptoSetupModal')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <h3>Set Up PTO Tracking</h3>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Let's configure your PTO settings to get started.</p>
      <div class="input-group">
        <label>Year Employment Started</label>
        <select id="ptoSetupStartYear"></select>
      </div>
      <div class="input-group">
        <label>Rollover Days from Last Year (max 8)</label>
        <input type="number" id="ptoSetupRollover" min="0" max="8" value="8">
      </div>
      <div class="input-group">
        <label>Your Initials</label>
        <input type="text" id="ptoSetupInitials" placeholder="e.g., JD" maxlength="5">
      </div>
      <div class="input-group">
        <label>Supervisor Name</label>
        <input type="text" id="ptoSetupSupervisor" placeholder="e.g., Jane">
      </div>
      <div class="input-group">
        <label>Supervisor Email</label>
        <input type="email" id="ptoSetupSupervisorEmail" placeholder="e.g., manager@company.com">
      </div>
      <div class="modal-actions">
        <button class="btn btn-accent" onclick="completePtoSetup()">Save & Get Started</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Confirm dialog -->
  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-dialog">
      <h4 id="confirmTitle">Confirm</h4>
      <p id="confirmMessage"></p>
      <div class="confirm-actions">
        <button class="btn btn-ghost" id="confirmCancel">Cancel</button>
        <button class="btn btn-accent" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    /* ── Toast & Confirm ── */
    function showToast(message, type = '') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast' + (type ? ` toast-${type}` : '');
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showConfirm(title, message, opts = {}) {
      return new Promise(resolve => {
        const overlay = document.getElementById('confirmOverlay');
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        const okBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');
        okBtn.textContent = opts.okText || 'Confirm';
        okBtn.className = opts.danger ? 'btn btn-danger' : 'btn btn-accent';
        cancelBtn.textContent = opts.cancelText || 'Cancel';
        overlay.classList.add('active');

        function cleanup(result) {
          overlay.classList.remove('active');
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
          resolve(result);
        }
        function onOk() { cleanup(true); }
        function onCancel() { cleanup(false); }
        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
      });
    }

    /* ── Shared State ── */
    let timerInterval = null;
    let startTime = null;
    let currentEditId = null;
    let currentEditTaskId = null;
    let timerViewDate = new Date();

    function getDateKey(d) { const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function formatTime(ms) {
      const s = Math.floor(ms / 1000);
      return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }

    function formatTimeShort(d) {
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function formatDateLabel(d) {
      return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      // Restore scroll if no other modals are open
      if (!document.querySelector('.modal-overlay.active')) {
        document.body.style.overflow = '';
      }
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    /* ── App Switcher ── */
    function switchApp(app) {
      document.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
      document.querySelector(`[onclick="switchApp('${app}')"]`).classList.add('active');
      document.getElementById(`view-${app}`).classList.add('active');
      
      if (app === 'pto') {
        const settings = getPtoSettings();
        if (settings) {
          renderPto();
        } else {
          initPto();
        }
      }
    }

    /* ══════════════════════════════════
       TIME TRACKER
       ══════════════════════════════════ */
    const defaultCategories = ['Code Review', 'Technical Assistance', 'Development', 'Meetings'];

    function getCategories() { return JSON.parse(localStorage.getItem('wb_categories')) || defaultCategories; }
    function getEntries() { return JSON.parse(localStorage.getItem('wb_timeEntries')) || []; }

    function updateCategorySelect() {
      const cats = getCategories().slice().sort((a, b) => a.localeCompare(b));
      ['category', 'editCategory', 'addEntryCategory'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = cats.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');
      });
    }

    function renderCategoryList() {
      const cats = getCategories().slice().sort((a, b) => a.localeCompare(b));
      document.getElementById('categoryList').innerHTML = cats.map((c, i) => `
        <div class="category-row" data-original="${esc(c)}">
          <input type="text" value="${esc(c)}">
          <button class="btn-icon danger" onclick="this.closest('.category-row').remove()" title="Delete" style="width:32px;height:32px;flex-shrink:0;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
        </div>
      `).join('') || '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:0.85rem;">No categories yet</div>';
    }

    function renameCategory() {} // no-op, kept for compat

    function addCategory() {
      const input = document.getElementById('newCategory');
      const name = input.value.trim();
      if (!name) return;
      const list = document.getElementById('categoryList');
      // Remove empty state if present
      if (!list.querySelector('.category-row')) list.innerHTML = '';
      const row = document.createElement('div');
      row.className = 'category-row';
      row.dataset.original = '';
      row.innerHTML = `<input type="text" value="${esc(name)}"><button class="btn-icon danger" onclick="this.closest('.category-row').remove()" title="Delete" style="width:32px;height:32px;flex-shrink:0;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>`;
      list.appendChild(row);
      input.value = '';
      input.focus();
    }

    function saveCategories() {
      const rows = document.querySelectorAll('#categoryList .category-row');
      const oldCats = getCategories();
      const newCats = [];
      const renames = {}; // old -> new

      rows.forEach(row => {
        const newName = row.querySelector('input').value.trim();
        const oldName = row.dataset.original;
        if (!newName) return;
        newCats.push(newName);
        if (oldName && oldName !== newName) {
          renames[oldName] = newName;
        }
      });

      // Find deleted categories
      const deleted = oldCats.filter(c => !newCats.includes(c) && !renames[c]);

      // Update entries for renames
      if (Object.keys(renames).length || deleted.length) {
        const entries = getEntries();
        let changed = false;
        entries.forEach(e => {
          if (renames[e.category]) {
            e.category = renames[e.category];
            changed = true;
          }
        });
        if (changed) localStorage.setItem('wb_timeEntries', JSON.stringify(entries));
      }

      localStorage.setItem('wb_categories', JSON.stringify(newCats));
      updateCategorySelect();
      closeModal('categoryModal');
      renderTimeEntries();
      showToast('Categories saved', 'success');
    }

    function removeCategory(name) {
      localStorage.setItem('wb_categories', JSON.stringify(getCategories().filter(c => c !== name)));
      updateCategorySelect();
      renderCategoryList();
    }

    function updateTimerDisplay() {
      document.getElementById('timerDisplay').textContent = formatTime(Date.now() - startTime.getTime());
    }

    function startTimer() {
      const desc = document.getElementById('description').value.trim();
      if (!desc) { document.getElementById('description').focus(); return; }
      startTime = new Date();
      localStorage.setItem('wb_runningTimer', JSON.stringify({
        startTime: startTime.toISOString(),
        description: desc,
        category: document.getElementById('category').value
      }));
      resumeTimer();
    }

    function resumeTimer() {
      document.getElementById('timerDisplay').classList.add('active');
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = 'block';
      updateTimerDisplay();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      const running = JSON.parse(localStorage.getItem('wb_runningTimer'));
      const entries = getEntries();
      entries.push({
        id: Date.now().toString(),
        description: running.description,
        category: running.category,
        startTime: running.startTime,
        endTime: new Date().toISOString()
      });
      localStorage.setItem('wb_timeEntries', JSON.stringify(entries));
      localStorage.removeItem('wb_runningTimer');
      document.getElementById('timerDisplay').classList.remove('active');
      document.getElementById('timerDisplay').textContent = '00:00:00';
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('description').value = '';
      renderTimeEntries();
    }

    function renderTimeEntries() {
      const dateKey = getDateKey(timerViewDate);
      const entries = getEntries().filter(e => getDateKey(new Date(e.startTime)) === dateKey)
        .sort((a,b) => new Date(a.startTime) - new Date(b.startTime));

      const container = document.getElementById('entriesList');
      const summary = document.getElementById('categorySummary');
      document.getElementById('timerCurrentDate').textContent = formatDateLabel(timerViewDate);

      // Show/hide Today button
      const timerIsToday = getDateKey(timerViewDate) === getDateKey(new Date());
      document.getElementById('timerTodayBtn').style.display = timerIsToday ? 'none' : 'inline-block';

      if (!entries.length) {
        container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><p>No entries for this day</p></div>`;
        summary.innerHTML = '';
        document.getElementById('totalTime').textContent = 'Total: 00:00:00';
        return;
      }

      let totalMs = 0;
      const catTotals = {};
      entries.forEach(e => { const d = new Date(e.endTime) - new Date(e.startTime); totalMs += d; catTotals[e.category] = (catTotals[e.category]||0) + d; });

      summary.innerHTML = Object.entries(catTotals).sort((a,b) => b[1]-a[1]).map(([cat,ms]) => `
        <div class="summary-card">
          <div class="summary-card-label">${esc(cat)}</div>
          <div class="summary-card-time">${formatTime(ms)}</div>
          <div class="summary-card-bar"><div class="summary-card-bar-fill" style="width:${ms/totalMs*100}%"></div></div>
        </div>`).join('');

      container.innerHTML = entries.map(e => {
        const s = new Date(e.startTime), en = new Date(e.endTime);
        return `<div class="entry">
          <div class="entry-time">${formatTimeShort(s)} – ${formatTimeShort(en)}</div>
          <div class="entry-details"><div class="entry-description">${esc(e.description)}</div><div class="entry-category">${esc(e.category)}</div></div>
          <div class="entry-duration">${formatTime(en - s)}</div>
          <div class="entry-actions">
            <button class="btn-icon resume" onclick="resumeEntry('${e.id}')" title="Continue this task"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg></button>
            <button class="btn-icon" onclick="openTimeEdit('${e.id}')" title="Edit"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
            <button class="btn-icon danger" onclick="deleteTimeEntry('${e.id}')" title="Delete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
          </div>
        </div>`;
      }).join('');

      document.getElementById('totalTime').textContent = `Total: ${formatTime(totalMs)}`;
    }

    function changeTimerDate(delta) { timerViewDate.setDate(timerViewDate.getDate() + delta); renderTimeEntries(); }

    function goToTimerToday() { timerViewDate = new Date(); renderTimeEntries(); }

    function openTimeEdit(id) {
      const e = getEntries().find(x => x.id === id);
      if (!e) return;
      currentEditId = id;
      document.getElementById('editDescription').value = e.description;
      document.getElementById('editCategory').value = e.category;
      const s = new Date(e.startTime), en = new Date(e.endTime);
      document.getElementById('editDate').value = getDateKey(s);
      document.getElementById('editStartTime').value = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}:${String(s.getSeconds()).padStart(2,'0')}`;
      document.getElementById('editEndTime').value = `${String(en.getHours()).padStart(2,'0')}:${String(en.getMinutes()).padStart(2,'0')}:${String(en.getSeconds()).padStart(2,'0')}`;
      openModal('editModal');
    }

    function saveEdit() {
      const entries = getEntries();
      const idx = entries.findIndex(e => e.id === currentEditId);
      if (idx === -1) return;
      
      const dv = document.getElementById('editDate').value;
      const sp = document.getElementById('editStartTime').value.split(':');
      const ep = document.getElementById('editEndTime').value.split(':');
      
      // Parse date parts explicitly for cross-browser compatibility
      const [year, month, day] = dv.split('-').map(Number);
      
      const sd = new Date(year, month - 1, day, +sp[0], +sp[1], +(sp[2] || 0));
      const ed = new Date(year, month - 1, day, +ep[0], +ep[1], +(ep[2] || 0));
      
      entries[idx] = { 
        ...entries[idx], 
        description: document.getElementById('editDescription').value, 
        category: document.getElementById('editCategory').value, 
        startTime: sd.toISOString(), 
        endTime: ed.toISOString() 
      };
      
      localStorage.setItem('wb_timeEntries', JSON.stringify(entries));
      closeModal('editModal');
      renderTimeEntries();
    }

    function saveNewEntry() {
      const description = document.getElementById('addEntryDescription').value.trim();
      if (!description) {
        showToast('Please enter a description', 'error');
        return;
      }
      
      const dateInput = document.getElementById('addEntryDate');
      const startTimeInput = document.getElementById('addEntryStartTime');
      const endTimeInput = document.getElementById('addEntryEndTime');
      
      const dv = dateInput.value;
      const startTime = startTimeInput.value;
      const endTime = endTimeInput.value;
      
      console.log('Date value:', dv, 'Start:', startTime, 'End:', endTime);
      
      if (!dv || !startTime || !endTime) {
        showToast('Please fill in date and times', 'error');
        return;
      }
      
      // Parse date - handle both YYYY-MM-DD and other formats
      let year, month, day;
      if (dv.includes('-')) {
        [year, month, day] = dv.split('-').map(Number);
      } else {
        // Fallback: try to parse as date object
        const parsed = new Date(dv);
        year = parsed.getFullYear();
        month = parsed.getMonth() + 1;
        day = parsed.getDate();
      }
      
      const [sh, sm] = startTime.split(':').map(Number);
      const [eh, em] = endTime.split(':').map(Number);
      
      console.log('Parsed:', year, month, day, 'Times:', sh, sm, '-', eh, em);
      
      const sd = new Date(year, month - 1, day, sh, sm, 0);
      const ed = new Date(year, month - 1, day, eh, em, 0);
      
      console.log('Start Date:', sd.toISOString(), 'End Date:', ed.toISOString());
      
      if (ed <= sd) {
        showToast('End time must be after start time', 'error');
        return;
      }
      
      const entries = getEntries();
      entries.push({
        id: Date.now().toString(),
        description: description,
        category: document.getElementById('addEntryCategory').value,
        startTime: sd.toISOString(),
        endTime: ed.toISOString()
      });
      
      localStorage.setItem('wb_timeEntries', JSON.stringify(entries));
      closeModal('addEntryModal');
      
      // Navigate to the date of the new entry
      timerViewDate = new Date(year, month - 1, day);
      renderTimeEntries();
    }

    async function deleteTimeEntry(id) {
      if (!await showConfirm('Delete Entry', 'Delete this time entry?', { okText: 'Delete', danger: true })) return;
      localStorage.setItem('wb_timeEntries', JSON.stringify(getEntries().filter(e => e.id !== id)));
      renderTimeEntries();
    }

    function resumeEntry(id) {
      // Don't resume if timer is already running
      if (localStorage.getItem('wb_runningTimer')) {
        showToast('A timer is already running. Stop it first.', 'error');
        return;
      }
      
      const entry = getEntries().find(e => e.id === id);
      if (!entry) return;
      
      // Start a new timer with the same description and category
      startTime = new Date();
      document.getElementById('description').value = entry.description;
      document.getElementById('category').value = entry.category;
      
      localStorage.setItem('wb_runningTimer', JSON.stringify({
        startTime: startTime.toISOString(),
        description: entry.description,
        category: entry.category
      }));
      
      resumeTimer();
      
      // Scroll to top to show the running timer
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ══════════════════════════════════
       TASKS
       ══════════════════════════════════ */
    function getTasks() { return JSON.parse(localStorage.getItem('wb_tasks')) || []; }
    function saveTasks(t) { localStorage.setItem('wb_tasks', JSON.stringify(t)); }

    let taskFilter = 'active';

    function setTaskFilter(f) {
      taskFilter = f;
      document.querySelectorAll('.task-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
      renderTasks();
    }

    function addTask() {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) { document.getElementById('taskTitle').focus(); return; }
      const tasks = getTasks();
      const activeTasks = tasks.filter(t => !t.done);
      const maxOrder = activeTasks.length ? Math.max(...activeTasks.map(t => t.order || 0)) : -1;
      tasks.push({ id: Date.now().toString(), title, notes: document.getElementById('taskNotes').value.trim(), date: getDateKey(new Date()), done: false, order: maxOrder + 1, createdAt: new Date().toISOString() });
      saveTasks(tasks);
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskNotes').value = '';
      taskFilter = 'active';
      document.querySelectorAll('.task-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'active'));
      renderTasks();
    }

    function toggleTask(id) {
      const tasks = getTasks();
      const t = tasks.find(x => x.id === id);
      if (!t) return;
      
      const wasUndone = !t.done;
      t.done = !t.done;
      t.completedAt = t.done ? new Date().toISOString() : null;
      saveTasks(tasks);
      
      if (wasUndone) {
        const taskEl = document.querySelector(`[data-task-id="${id}"]`);
        if (taskEl) taskEl.classList.add('completing');
        showCelebration();
        setTimeout(() => renderTasks(), 600);
      } else {
        renderTasks();
      }
    }

    function showCelebration() {
      const celebration = document.createElement('div');
      celebration.className = 'celebration';
      celebration.innerHTML = `
        <div class="celebration-inner">
          <div class="confetti"></div><div class="confetti"></div><div class="confetti"></div>
          <div class="confetti"></div><div class="confetti"></div><div class="confetti"></div>
          <div class="celebration-check"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="celebration-text">Done!</div>
        </div>`;
      document.body.appendChild(celebration);
      setTimeout(() => celebration.remove(), 900);
    }

    async function deleteTask(id) {
      if (!await showConfirm('Delete Task', 'Delete this task?', { okText: 'Delete', danger: true })) return;
      saveTasks(getTasks().filter(t => t.id !== id));
      renderTasks();
    }

    function openTaskEdit(id) {
      const t = getTasks().find(x => x.id === id);
      if (!t) return;
      currentEditTaskId = id;
      document.getElementById('editTaskTitle').value = t.title;
      document.getElementById('editTaskNotes').value = t.notes || '';
      openModal('editTaskModal');
    }

    function saveTaskEdit() {
      const tasks = getTasks();
      const idx = tasks.findIndex(t => t.id === currentEditTaskId);
      if (idx === -1) return;
      tasks[idx] = { ...tasks[idx], title: document.getElementById('editTaskTitle').value.trim(), notes: document.getElementById('editTaskNotes').value.trim() };
      saveTasks(tasks);
      closeModal('editTaskModal');
      renderTasks();
    }

    function formatRelativeDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const today = new Date();
      const diffDays = Math.floor((today - d) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays}d ago`;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function renderTasks() {
      const allTasks = getTasks();
      const container = document.getElementById('taskList');

      let tasks;
      if (taskFilter === 'active') tasks = allTasks.filter(t => !t.done);
      else if (taskFilter === 'done') tasks = allTasks.filter(t => t.done);
      else tasks = [...allTasks];

      const totalActive = allTasks.filter(t => !t.done).length;
      const totalDone = allTasks.filter(t => t.done).length;
      document.getElementById('taskStats').innerHTML = `<strong>${totalDone}</strong> / ${allTasks.length} done`;

      if (!tasks.length) {
        const msg = taskFilter === 'done' ? 'No completed tasks yet' : taskFilter === 'active' ? 'All caught up!' : 'No tasks yet';
        container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><p>${msg}</p></div>`;
        return;
      }

      // Sort: active by order, done by completedAt (newest first)
      if (taskFilter === 'active') {
        tasks.sort((a, b) => (a.order || 0) - (b.order || 0));
      } else if (taskFilter === 'done') {
        tasks.sort((a, b) => new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt));
      } else {
        const undone = tasks.filter(t => !t.done).sort((a, b) => (a.order || 0) - (b.order || 0));
        const done = tasks.filter(t => t.done).sort((a, b) => new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt));
        tasks = [...undone, ...done];
      }

      container.innerHTML = tasks.map(t => {
        const createdDate = formatRelativeDate(t.createdAt || t.date);
        const completedDate = t.completedAt ? formatRelativeDate(t.completedAt) : '';
        const dateMeta = t.done
          ? `<span class="completed-label">Completed ${completedDate}</span> · Added ${createdDate}`
          : `Added ${createdDate}`;

        return `
        <div class="task-item ${t.done ? 'done' : ''}" draggable="${!t.done}" data-task-id="${t.id}"
             ondragstart="onTaskDragStart(event)" ondragend="onTaskDragEnd(event)"
             ondragover="onTaskDragOver(event)" ondragleave="onTaskDragLeave(event)" ondrop="onTaskDrop(event)">
          <div class="drag-handle" ${t.done ? '' : 'title="Drag to reorder"'}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/>
              <circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/>
              <circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/>
            </svg>
          </div>
          <button class="task-checkbox ${t.done ? 'checked' : ''}" onclick="toggleTask('${t.id}')">
            ${t.done ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
          </button>
          <div class="task-content">
            <div class="task-title">${esc(t.title)}</div>
            ${t.notes ? `<div class="task-notes">${esc(t.notes)}</div>` : ''}
            <div class="task-date-meta">${dateMeta}</div>
          </div>
          <div class="task-actions">
            <button class="btn-icon" onclick="openTaskEdit('${t.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
            <button class="btn-icon danger" onclick="deleteTask('${t.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
          </div>
        </div>`;
      }).join('');
    }

    /* ── Task Drag & Drop ── */
    let draggedTaskId = null;

    function onTaskDragStart(e) {
      draggedTaskId = e.currentTarget.dataset.taskId;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function onTaskDragEnd(e) {
      draggedTaskId = null;
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.task-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function onTaskDragOver(e) {
      e.preventDefault();
      const target = e.currentTarget;
      if (target.dataset.taskId === draggedTaskId) return;
      if (target.classList.contains('done')) return;
      e.dataTransfer.dropEffect = 'move';
      target.classList.add('drag-over');
    }

    function onTaskDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

    function onTaskDrop(e) {
      e.preventDefault();
      const targetEl = e.currentTarget;
      targetEl.classList.remove('drag-over');
      const targetId = targetEl.dataset.taskId;
      if (!draggedTaskId || targetId === draggedTaskId) return;

      const tasks = getTasks();
      const undone = tasks.filter(t => !t.done);
      undone.forEach((t, i) => { if (t.order === undefined) t.order = i; });
      undone.sort((a, b) => a.order - b.order);

      const fromIdx = undone.findIndex(t => t.id === draggedTaskId);
      const toIdx = undone.findIndex(t => t.id === targetId);
      if (fromIdx === -1 || toIdx === -1) return;

      const [moved] = undone.splice(fromIdx, 1);
      undone.splice(toIdx, 0, moved);
      undone.forEach((t, i) => { t.order = i; });

      const orderMap = {};
      undone.forEach(t => { orderMap[t.id] = t.order; });
      tasks.forEach(t => { if (orderMap[t.id] !== undefined) t.order = orderMap[t.id]; });

      saveTasks(tasks);
      renderTasks();
    }

    /* ══════════════════════════════════
       NOTES
       ══════════════════════════════════ */
    let currentNoteDate = null;
    let saveTimeout = null;

    function getNotes() { return JSON.parse(localStorage.getItem('wb_notes')) || {}; }
    function saveNotes(notes) { localStorage.setItem('wb_notes', JSON.stringify(notes)); }

    const NOTES_PAGE_SIZE = 10;
    let notesShowCount = NOTES_PAGE_SIZE;

    function renderNotes() {
      const notes = getNotes();
      const container = document.getElementById('notesCards');
      const dates = Object.keys(notes).sort((a, b) => b.localeCompare(a));
      const countEl = document.getElementById('notesCount');

      if (!dates.length) {
        countEl.innerHTML = '<strong>0</strong> notes';
      } else {
        const newest = new Date(dates[0] + 'T00:00:00');
        const today = new Date(); today.setHours(0,0,0,0);
        const daysSince = Math.floor((today - newest) / (1000 * 60 * 60 * 24));
        const recency = daysSince === 0 ? 'Last note today' : daysSince === 1 ? 'Last note yesterday' : `Last note ${daysSince}d ago`;
        countEl.innerHTML = `<strong>${dates.length}</strong> note${dates.length !== 1 ? 's' : ''} <span class="notes-count-sep">·</span> <span class="notes-count-detail">${recency}</span>`;
      }

      if (!dates.length) {
        container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><p>No notes yet</p></div>`;
        return;
      }

      const visible = dates.slice(0, notesShowCount);
      const remaining = dates.length - visible.length;

      let html = visible.map(dateKey => {
        const content = notes[dateKey];
        const d = new Date(dateKey + 'T00:00:00');
        const dateLabel = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
        const words = content.trim().split(/\s+/).length;
        const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;

        return `
        <div class="note-card" onclick="openNoteEditor('${dateKey}')">
          <div class="note-card-header">
            <div class="note-card-date">${dateLabel}</div>
            <div class="note-card-actions">
              <button class="btn-icon danger" onclick="event.stopPropagation(); deleteNote('${dateKey}')" title="Delete"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
            </div>
          </div>
          <div class="note-card-preview">${esc(preview)}</div>
          <div class="note-card-words">${words} word${words !== 1 ? 's' : ''}</div>
        </div>`;
      }).join('');

      if (remaining > 0) {
        html += `<button class="btn btn-ghost notes-show-more" onclick="showMoreNotes()">Show ${Math.min(remaining, NOTES_PAGE_SIZE)} more note${Math.min(remaining, NOTES_PAGE_SIZE) !== 1 ? 's' : ''}<span class="notes-remaining-count">${remaining} remaining</span></button>`;
      }

      container.innerHTML = html;
    }

    function showMoreNotes() {
      notesShowCount += NOTES_PAGE_SIZE;
      renderNotes();
    }

    function openNoteEditor(dateKey) {
      if (dateKey) {
        currentNoteDate = dateKey;
        const notes = getNotes();
        document.getElementById('notesEditor').value = notes[dateKey] || '';
        document.getElementById('noteDate').value = dateKey;
        document.getElementById('noteModalTitle').textContent = 'Edit Note';
      } else {
        currentNoteDate = getDateKey(new Date());
        document.getElementById('notesEditor').value = '';
        document.getElementById('noteDate').value = currentNoteDate;
        document.getElementById('noteModalTitle').textContent = 'New Note';
      }
      openModal('noteEditorModal');
      autoExpandEditor();
      updateWordCount();
      updateSaveStatus('');
      setTimeout(() => document.getElementById('notesEditor').focus(), 50);
    }

    function closeNoteEditor() {
      saveCurrentNote();
      closeModal('noteEditorModal');
      currentNoteDate = null;
      notesShowCount = NOTES_PAGE_SIZE;
      renderNotes();
    }

    function onNoteDateChange() {
      // Save current content under old date, then switch
      saveCurrentNote();
      currentNoteDate = document.getElementById('noteDate').value;
      const notes = getNotes();
      document.getElementById('notesEditor').value = notes[currentNoteDate] || '';
      autoExpandEditor();
      updateWordCount();
    }

    async function deleteNote(dateKey) {
      if (!await showConfirm('Delete Note', 'Delete this note?', { okText: 'Delete', danger: true })) return;
      const notes = getNotes();
      delete notes[dateKey];
      saveNotes(notes);
      renderNotes();
    }

    function saveCurrentNote() {
      if (!currentNoteDate) return;
      const notes = getNotes();
      const content = document.getElementById('notesEditor').value;
      if (content.trim()) {
        notes[currentNoteDate] = content;
      } else {
        delete notes[currentNoteDate];
      }
      saveNotes(notes);
    }

    function autoExpandEditor() {
      const editor = document.getElementById('notesEditor');
      editor.style.height = 'auto';
      const maxHeight = window.innerHeight * 0.7;
      editor.style.height = Math.min(maxHeight, Math.max(360, editor.scrollHeight)) + 'px';
    }

    function updateWordCount() {
      const content = document.getElementById('notesEditor').value.trim();
      const words = content ? content.split(/\s+/).length : 0;
      document.getElementById('wordCount').textContent = words === 1 ? '1 word' : `${words} words`;
    }

    function onNotesInput() {
      autoExpandEditor();
      updateWordCount();
      
      clearTimeout(saveTimeout);
      updateSaveStatus('Saving...');
      
      saveTimeout = setTimeout(() => {
        saveCurrentNote();
        updateSaveStatus('Saved');
      }, 500);
    }

    function updateSaveStatus(status) {
      const el = document.getElementById('saveStatus');
      el.textContent = status;
      el.className = 'save-status' + (status === 'Saved' ? ' saved' : '');
    }

    /* ── Date Picker Popover ── */
    const dpState = { timer: new Date() };

    function getContentDates(view) {
      const dates = new Set();
      if (view === 'timer') {
        getEntries().forEach(e => dates.add(getDateKey(new Date(e.startTime))));
      }
      return dates;
    }

    function renderDatePicker(view) {
      const el = document.getElementById('dp' + view.charAt(0).toUpperCase() + view.slice(1));
      const dt = dpState[view];
      const year = dt.getFullYear();
      const month = dt.getMonth();
      const today = getDateKey(new Date());
      const contentDates = getContentDates(view);

      // Current selected date for this view
      let selectedDate = getDateKey(timerViewDate);

      const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevMonthDays = new Date(year, month, 0).getDate();

      let html = `<div class="date-picker-header">
        <button onclick="changeDpMonth('${view}', -1)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
        <span>${monthName}</span>
        <button onclick="changeDpMonth('${view}', 1)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
      </div><div class="date-picker-grid">`;

      ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
        html += `<div class="dp-day-header">${d}</div>`;
      });

      // Previous month trailing days
      for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="dp-day dp-other-month">${prevMonthDays - i}</div>`;
      }

      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const classes = ['dp-day'];
        if (dateStr === today) classes.push('dp-today');
        if (dateStr === selectedDate) classes.push('dp-selected');
        if (contentDates.has(dateStr)) classes.push('dp-has-content');
        html += `<div class="${classes.join(' ')}" onclick="pickDate('${view}', '${dateStr}')">${d}</div>`;
      }

      // Next month leading days
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="dp-day dp-other-month">${i}</div>`;
      }

      html += '</div>';
      el.innerHTML = html;
    }

    function changeDpMonth(view, delta) {
      dpState[view].setMonth(dpState[view].getMonth() + delta);
      renderDatePicker(view);
    }

    function pickDate(view, dateStr) {
      const parts = dateStr.split('-');
      const d = new Date(+parts[0], +parts[1] - 1, +parts[2]);
      if (view === 'timer') { timerViewDate = d; renderTimeEntries(); }
      closeAllDatePickers();
    }

    function toggleDatePicker(view) {
      const el = document.getElementById('dp' + view.charAt(0).toUpperCase() + view.slice(1));
      const isOpen = el.classList.contains('active');
      closeAllDatePickers();
      if (!isOpen) {
        if (view === 'timer') dpState[view] = new Date(timerViewDate);
        renderDatePicker(view);
        el.classList.add('active');
        document.getElementById('dpBackdrop').classList.add('active');
      }
    }

    function closeAllDatePickers() {
      document.querySelectorAll('.date-picker-popover').forEach(p => p.classList.remove('active'));
      document.getElementById('dpBackdrop').classList.remove('active');
    }

    // Formatting helpers
    function formatBold() {
      const editor = document.getElementById('notesEditor');
      wrapSelection(editor, '**', '**');
    }

    function formatList() {
      const editor = document.getElementById('notesEditor');
      const start = editor.selectionStart;
      const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
      editor.setSelectionRange(lineStart, lineStart);
      insertText(editor, '- ');
    }

    function formatCode() {
      const editor = document.getElementById('notesEditor');
      const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
      if (selected.includes('\n')) {
        wrapSelection(editor, '```\n', '\n```');
      } else {
        wrapSelection(editor, '`', '`');
      }
    }

    function wrapSelection(textarea, before, after) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selected = text.substring(start, end);
      
      textarea.value = text.substring(0, start) + before + selected + after + text.substring(end);
      textarea.selectionStart = start + before.length;
      textarea.selectionEnd = start + before.length + selected.length;
      textarea.focus();
      onNotesInput();
    }

    function insertText(textarea, text) {
      const start = textarea.selectionStart;
      const val = textarea.value;
      textarea.value = val.substring(0, start) + text + val.substring(start);
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
      textarea.focus();
      onNotesInput();
    }

    // Keyboard shortcut for bold
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'b' && document.activeElement.id === 'notesEditor') {
        e.preventDefault();
        formatBold();
      }
    });

    /* ══════════════════════════════════
       STATS
       ══════════════════════════════════ */
    let statsPeriod = 'week';

    function setStatsPeriod(period) {
      statsPeriod = period;
      document.querySelectorAll('.stats-period button').forEach(b => {
        b.classList.toggle('active', b.textContent.toLowerCase().includes(period));
      });
      renderStats();
    }

    function renderStats() {
      const entries = getEntries();
      const tasks = getTasks();
      
      if (!entries.length) {
        document.getElementById('statsContent').innerHTML = `
          <div class="stats-empty">
            <p>No time entries yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Start tracking to see your stats!</p>
          </div>`;
        return;
      }

      // Filter by period
      const now = new Date();
      let startDate;
      
      if (statsPeriod === 'week') {
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 7);
      } else if (statsPeriod === 'month') {
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 30);
      } else {
        startDate = new Date(0);
      }

      const filtered = entries.filter(e => new Date(e.startTime) >= startDate);
      
      if (!filtered.length) {
        document.getElementById('statsContent').innerHTML = `
          <div class="stats-empty">
            <p>No entries in this period.</p>
          </div>`;
        return;
      }

      // Calculate stats for filtered period
      let totalMs = 0;
      const catTotals = {};
      const daySet = new Set();

      filtered.forEach(e => {
        const duration = new Date(e.endTime) - new Date(e.startTime);
        totalMs += duration;
        catTotals[e.category] = (catTotals[e.category] || 0) + duration;
        daySet.add(getDateKey(new Date(e.startTime)));
      });

      const totalHours = totalMs / (1000 * 60 * 60);
      const todayKey = getDateKey(new Date());
      const completedDays = [...daySet].filter(d => d !== todayKey);

      // Avg/day excludes today (incomplete) — uses only fully completed days
      let completedDaysMs = 0;
      filtered.forEach(e => {
        const dk = getDateKey(new Date(e.startTime));
        if (dk !== todayKey) completedDaysMs += new Date(e.endTime) - new Date(e.startTime);
      });
      const avgPerDayFinal = completedDays.length > 0 ? completedDaysMs / completedDays.length / (1000 * 60 * 60) : totalHours;

      // Tasks stats
      const filteredTasks = tasks.filter(t => {
        const taskDate = new Date(t.date);
        return taskDate >= startDate;
      });
      const completedTasks = filteredTasks.filter(t => t.done).length;

      // Sort categories by time (for period)
      const sortedCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
      const maxCatMs = sortedCats[0] ? sortedCats[0][1] : 1;

      document.getElementById('statsContent').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${totalHours.toFixed(1)}h</div>
            <div class="stat-label">Total Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${avgPerDayFinal.toFixed(1)}h</div>
            <div class="stat-label">Avg / Day</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${completedTasks}</div>
            <div class="stat-label">Tasks Done</div>
          </div>
        </div>

        <div class="stats-section">
          <div class="stats-section-title">Time by Category</div>
          <div class="stats-bar-list">
            ${sortedCats.length ? sortedCats.map(([cat, ms]) => `
              <div class="stats-bar-item">
                <div class="stats-bar-label">${esc(cat)}</div>
                <div class="stats-bar-track">
                  <div class="stats-bar-fill" style="width: ${(ms / maxCatMs) * 100}%"></div>
                </div>
                <div class="stats-bar-value">${(ms / (1000 * 60 * 60)).toFixed(1)}h</div>
              </div>
            `).join('') : '<p style="color: var(--text-muted); font-size: 0.85rem;">No data for this period</p>'}
          </div>
        </div>

        <div class="stats-section">
          <div class="stats-section-title">Category Breakdown</div>
          <div class="stats-percentage-list">
            ${sortedCats.length ? sortedCats.map(([cat, ms]) => {
              const pct = ((ms / totalMs) * 100).toFixed(1);
              return `
              <div class="stats-percentage-item">
                <div class="stats-percentage-bar" style="width: ${pct}%"></div>
                <div class="stats-percentage-label">${esc(cat)}</div>
                <div class="stats-percentage-value">${pct}%</div>
              </div>
            `}).join('') : '<p style="color: var(--text-muted); font-size: 0.85rem;">No data for this period</p>'}
          </div>
        </div>

      `;
    }

    // Render content when modals open
    const origOpenModal = openModal;
    openModal = function(id) {
      if (id === 'statsModal') renderStats();
      if (id === 'categoryModal') renderCategoryList();
      if (id === 'ptoSettingsModal') loadPtoSettingsForm();
      if (id === 'editHolidaysModal') renderEditHolidays();
      if (id === 'settingsModal') loadFeatureToggles();
      if (id === 'addEntryModal') {
        // Default to currently viewed date and reasonable times
        document.getElementById('addEntryDate').value = getDateKey(timerViewDate);
        document.getElementById('addEntryStartTime').value = '09:00';
        document.getElementById('addEntryEndTime').value = '10:00';
        document.getElementById('addEntryDescription').value = '';
        updateCategorySelect();
      }
      document.getElementById(id).classList.add('active');
      document.body.style.overflow = 'hidden';
    };

    /* ══════════════════════════════════
       PTO TRACKER
       ══════════════════════════════════ */
    let ptoCalendarDate = new Date();
    let ptoSelectedDays = [];

    const PTO_YEAR = 2026;
    const PTO_ALLOTMENT = {
      2026: 15, 2025: 15, 2024: 18, 2023: 20, 2022: 21, 2021: 22,
      2020: 23, 2019: 24, 2018: 25, 2017: 26, 2016: 28, 2015: 28,
      2014: 28, 2013: 28, 2012: 28, 2011: 28, 2010: 30
    };

    const DEFAULT_HOLIDAYS_2026 = [
      { date: '2026-01-01', name: "New Year's Day", note: 'CLOSED' },
      { date: '2026-01-19', name: 'MLK Jr. Day', note: 'CLOSED' },
      { date: '2026-04-03', name: 'Good Friday', note: 'CLOSED' },
      { date: '2026-05-25', name: 'Memorial Day', note: 'CLOSED' },
      { date: '2026-06-19', name: 'Juneteenth', note: 'CLOSED' },
      { date: '2026-07-03', name: 'Independence Day', note: 'CLOSED' },
      { date: '2026-09-07', name: 'Labor Day', note: 'CLOSED' },
      { date: '2026-11-25', name: 'Day Before Thanksgiving', note: 'CLOSED 1PM' },
      { date: '2026-11-26', name: 'Thanksgiving', note: 'CLOSED' },
      { date: '2026-11-27', name: 'Day After Thanksgiving', note: 'CLOSED' },
      { date: '2026-12-24', name: 'Christmas Eve', note: 'CLOSED' },
      { date: '2026-12-25', name: 'Christmas Day', note: 'CLOSED' },
      { date: '2026-12-28', name: 'Extended Holiday', note: 'Volunteers' },
      { date: '2026-12-29', name: 'Extended Holiday', note: 'Volunteers' },
      { date: '2026-12-30', name: 'Extended Holiday', note: 'Volunteers' },
      { date: '2026-12-31', name: 'New Year\'s Eve', note: 'Volunteers' }
    ];

    function getPtoSettings() {
      return JSON.parse(localStorage.getItem('wb_ptoSettings')) || null;
    }

    function storePtoSettings(settings) {
      localStorage.setItem('wb_ptoSettings', JSON.stringify(settings));
    }

    function getPtoEntries() {
      return JSON.parse(localStorage.getItem('wb_ptoEntries')) || [];
    }

    function savePtoEntries(entries) {
      localStorage.setItem('wb_ptoEntries', JSON.stringify(entries));
    }

    function getPtoHolidays() {
      return JSON.parse(localStorage.getItem('wb_ptoHolidays')) || DEFAULT_HOLIDAYS_2026;
    }

    function savePtoHolidays(holidays) {
      localStorage.setItem('wb_ptoHolidays', JSON.stringify(holidays));
    }

    function getPtoDaysForYear(startYear) {
      if (startYear >= 2026) return 15;
      if (startYear <= 2010) return 30;
      return PTO_ALLOTMENT[startYear] || 15;
    }

    function initPto() {
      const settings = getPtoSettings();
      if (!settings) {
        // Show setup prompt, hide content
        document.getElementById('ptoSetupPrompt').style.display = 'block';
        document.getElementById('ptoContent').style.display = 'none';
        populateYearSelects();
      } else {
        // Hide setup prompt, show content
        document.getElementById('ptoSetupPrompt').style.display = 'none';
        document.getElementById('ptoContent').style.display = 'block';
        renderPto();
      }
    }

    function populateYearSelects() {
      const currentYear = new Date().getFullYear();
      const years = [];
      for (let y = currentYear; y >= 2010; y--) years.push(y);
      
      const options = years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      ['ptoStartYear', 'ptoSetupStartYear'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = options;
      });
    }

    function loadPtoSettingsForm() {
      populateYearSelects();
      const settings = getPtoSettings();
      if (settings) {
        document.getElementById('ptoStartYear').value = settings.startYear || 2025;
        document.getElementById('ptoRollover').value = settings.rolloverDays || 0;
        document.getElementById('ptoInitials').value = settings.initials || '';
        document.getElementById('ptoSupervisor').value = settings.supervisorName || '';
        document.getElementById('ptoSupervisorEmail').value = settings.supervisorEmail || '';
        document.getElementById('ptoExcludeRollover').checked = settings.excludeRollover !== false;
      }
      const holidayCountEl = document.getElementById('ptoHolidayCount');
      if (holidayCountEl) {
        const holidayCount = getPtoHolidays().length;
        holidayCountEl.textContent = `${holidayCount} holiday${holidayCount !== 1 ? 's' : ''} configured`;
      }
    }

    function savePtoSettings() {
      const settings = {
        startYear: parseInt(document.getElementById('ptoStartYear').value),
        rolloverDays: parseInt(document.getElementById('ptoRollover').value) || 0,
        initials: document.getElementById('ptoInitials').value.trim(),
        supervisorName: document.getElementById('ptoSupervisor').value.trim(),
        supervisorEmail: document.getElementById('ptoSupervisorEmail').value.trim(),
        excludeRollover: document.getElementById('ptoExcludeRollover').checked
      };
      storePtoSettings(settings);
      closeModal('ptoSettingsModal');
      renderPto();
    }

    function completePtoSetup() {
      const settings = {
        startYear: parseInt(document.getElementById('ptoSetupStartYear').value),
        rolloverDays: parseInt(document.getElementById('ptoSetupRollover').value) || 0,
        initials: document.getElementById('ptoSetupInitials').value.trim(),
        supervisorName: document.getElementById('ptoSetupSupervisor').value.trim(),
        supervisorEmail: document.getElementById('ptoSetupSupervisorEmail').value.trim(),
        excludeRollover: true
      };
      
      if (!settings.initials || !settings.supervisorName) {
        showToast('Please fill in your initials and supervisor name.', 'error');
        return;
      }
      
      storePtoSettings(settings);
      savePtoHolidays(DEFAULT_HOLIDAYS_2026);
      closeModal('ptoSetupModal');
      
      // Show content, hide prompt
      document.getElementById('ptoSetupPrompt').style.display = 'none';
      document.getElementById('ptoContent').style.display = 'block';
      renderPto();
    }

    function renderPto() {
      const settings = getPtoSettings();
      if (!settings) {
        initPto();
        return;
      }

      // Ensure content is visible
      document.getElementById('ptoSetupPrompt').style.display = 'none';
      document.getElementById('ptoContent').style.display = 'block';

      const entries = getPtoEntries();
      const holidays = getPtoHolidays();
      const baseDays = getPtoDaysForYear(settings.startYear);
      const totalDays = baseDays + (settings.rolloverDays || 0);
      const usedDays = entries.length;
      const remainingDays = totalDays - usedDays;
      
      // Calculate percentage (optionally excluding rollover)
      const percentBase = settings.excludeRollover ? baseDays : totalDays;
      const percentUsed = percentBase > 0 ? ((usedDays / percentBase) * 100).toFixed(1) : 0;

      // Check if using rollover days
      const usingRollover = usedDays > baseDays;
      const rolloverUsed = usingRollover ? usedDays - baseDays : 0;
      const rolloverRemaining = (settings.rolloverDays || 0) - rolloverUsed;

      // Days since last PTO
      let daysSinceLastPto = null;
      if (entries.length > 0) {
        const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));
        const lastPto = new Date(sortedEntries[0].date);
        const today = new Date();
        daysSinceLastPto = Math.floor((today - lastPto) / (1000 * 60 * 60 * 24));
      }

      // Render stats
      document.getElementById('ptoStats').innerHTML = `
        <div class="pto-stat-card">
          <div class="pto-stat-value">${usedDays}</div>
          <div class="pto-stat-label">Days Used</div>
        </div>
        <div class="pto-stat-card ${remainingDays <= 3 ? 'warning' : ''}">
          <div class="pto-stat-value">${remainingDays}</div>
          <div class="pto-stat-label">Days Left</div>
        </div>
        <div class="pto-stat-card">
          <div class="pto-stat-value">${percentUsed}%</div>
          <div class="pto-stat-label">Used${settings.excludeRollover ? ' (excl. rollover)' : ''}</div>
        </div>
        <div class="pto-stat-card ${usingRollover ? 'warning' : ''}">
          <div class="pto-stat-value">${rolloverRemaining}</div>
          <div class="pto-stat-label">Rollover Left</div>
        </div>
      `;

      // Holiday alert
      const today = new Date();
      const todayStr = getDateKey(today);
      const upcomingHolidays = holidays.filter(h => h.date >= todayStr).sort((a, b) => a.date.localeCompare(b.date));
      const nextHoliday = upcomingHolidays[0];
      
      if (nextHoliday) {
        const holidayDate = new Date(nextHoliday.date + 'T00:00:00');
        const daysUntil = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));
        
        let titleText;
        if (daysUntil === 0) titleText = `Today is ${nextHoliday.name}!`;
        else if (daysUntil === 1) titleText = `Tomorrow is ${nextHoliday.name}!`;
        else titleText = `${daysUntil} days until ${nextHoliday.name}!`;

        document.getElementById('ptoHolidayAlert').innerHTML = `
          <div class="pto-holiday-alert-icon">🎉</div>
          <div class="pto-holiday-alert-title">${titleText}</div>
          <div class="pto-holiday-alert-date">${formatPtoDateLong(nextHoliday.date)}</div>
        `;
      } else {
        document.getElementById('ptoHolidayAlert').innerHTML = '';
      }

      // Render calendar
      renderPtoCalendar();

      // Render selected days
      renderPtoSelectedDays();

      // Render history
      renderPtoHistory();

      // Render holidays sidebar
      document.getElementById('ptoHolidays').innerHTML = holidays.map((h, idx) => {
        const isPast = h.date < todayStr;
        const isNext = nextHoliday && h.date === nextHoliday.date;
        return `
          <div class="pto-holiday-item ${isPast ? 'past' : ''} ${isNext ? 'next' : ''}">
            <div class="pto-holiday-info">
              <div class="pto-holiday-name" title="${esc(h.name)}">${h.name}</div>
              <div class="pto-holiday-date">${formatPtoDateShort(h.date)}</div>
            </div>
            <div class="pto-holiday-actions">
              <button class="btn-icon" onclick="editSingleHoliday(${idx})" title="Edit" style="width:28px;height:28px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
              <button class="btn-icon danger" onclick="deleteSingleHoliday(${idx})" title="Delete" style="width:28px;height:28px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
            </div>
          </div>
        `;
      }).join('');

      // Add nudge if it's been a while
      if (daysSinceLastPto !== null && daysSinceLastPto > 60) {
        document.getElementById('ptoHolidays').innerHTML += `
          <div class="pto-nudge">
            ⏰ It's been ${daysSinceLastPto} days since your last PTO. Maybe time for a break?
          </div>
        `;
      }
    }

    function renderPtoCalendar() {
      const settings = getPtoSettings();
      const entries = getPtoEntries();
      const holidays = getPtoHolidays();
      const usedDates = new Set(entries.map(e => e.date));
      const holidayDates = new Set(holidays.map(h => h.date));

      const year = ptoCalendarDate.getFullYear();
      const month = ptoCalendarDate.getMonth();
      
      document.getElementById('ptoCalendarMonth').textContent = 
        ptoCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startPadding = firstDay.getDay();
      const today = getDateKey(new Date());

      let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        .map(d => `<div class="pto-calendar-day-header">${d}</div>`).join('');

      // Previous month padding
      const prevMonth = new Date(year, month, 0);
      for (let i = startPadding - 1; i >= 0; i--) {
        const day = prevMonth.getDate() - i;
        html += `<div class="pto-calendar-day other-month">${day}</div>`;
      }

      // Current month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayOfWeek = new Date(year, month, day).getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const isToday = date === today;
        const isSelected = ptoSelectedDays.includes(date);
        const isHoliday = holidayDates.has(date);
        const isUsed = usedDates.has(date);

        let classes = ['pto-calendar-day'];
        if (isWeekend) classes.push('weekend');
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');
        if (isHoliday) classes.push('holiday');
        if (isUsed) classes.push('used');

        const clickable = !isWeekend && !isHoliday && !isUsed && year === PTO_YEAR;
        html += `<div class="${classes.join(' ')}" ${clickable ? `onclick="togglePtoDay('${date}')"` : ''}>${day}</div>`;
      }

      // Next month padding
      const remaining = 42 - (startPadding + lastDay.getDate());
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="pto-calendar-day other-month">${i}</div>`;
      }

      document.getElementById('ptoCalendar').innerHTML = html;
    }

    function changePtoMonth(delta) {
      ptoCalendarDate.setMonth(ptoCalendarDate.getMonth() + delta);
      renderPtoCalendar();
    }

    function togglePtoDay(date) {
      const idx = ptoSelectedDays.indexOf(date);
      if (idx >= 0) {
        ptoSelectedDays.splice(idx, 1);
      } else {
        ptoSelectedDays.push(date);
      }
      ptoSelectedDays.sort();
      renderPtoCalendar();
      renderPtoSelectedDays();
    }

    function renderPtoSelectedDays() {
      const container = document.getElementById('ptoSelected');
      const emailSection = document.getElementById('ptoEmailSection');

      if (ptoSelectedDays.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 24px 16px;">Click on calendar days to select your time off</p>';
        emailSection.style.display = 'none';
        return;
      }

      container.innerHTML = `
        <div class="pto-selected-days">
          ${ptoSelectedDays.map(d => `
            <div class="pto-selected-day">
              ${formatPtoDate(d)}
              <button onclick="togglePtoDay('${d}')">&times;</button>
            </div>
          `).join('')}
        </div>
      `;

      emailSection.style.display = 'block';
      generatePtoEmail();
    }

    function generatePtoEmail() {
      const settings = getPtoSettings();
      if (!settings || ptoSelectedDays.length === 0) return;

      const daysText = ptoSelectedDays.map(d => '• ' + formatPtoDateLong(d)).join('\n');
      const monthNames = [...new Set(ptoSelectedDays.map(d => {
        const date = new Date(d + 'T00:00:00');
        return date.toLocaleDateString('en-US', { month: 'long' });
      }))];

      const monthText = monthNames.length === 1 ? monthNames[0] : 'the following dates';
      
      const email = `Hi ${settings.supervisorName},\n\nI would like to take the following day${ptoSelectedDays.length > 1 ? 's' : ''} off in ${monthText}:\n\n${daysText}`;

      document.getElementById('ptoEmailPreview').value = email;
    }

    function copyPtoEmail() {
      const text = document.getElementById('ptoEmailPreview').value;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Email copied to clipboard!', 'success');
      });
    }

    function openPtoEmailClient() {
      const settings = getPtoSettings();
      const subject = encodeURIComponent(`PTO - ${settings.initials}`);
      const body = encodeURIComponent(document.getElementById('ptoEmailPreview').value);
      const email = settings.supervisorEmail || '';
      window.open(`mailto:${email}?subject=${subject}&body=${body}`);
    }

    async function confirmPtoRequest() {
      if (!await showConfirm('Confirm PTO', `This will log ${ptoSelectedDays.length} day(s) to your PTO history.`, { okText: 'Confirm' })) {
        return;
      }

      const entries = getPtoEntries();
      ptoSelectedDays.forEach(date => {
        if (!entries.find(e => e.date === date)) {
          entries.push({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            date,
            type: 'vacation',
            confirmedAt: new Date().toISOString()
          });
        }
      });

      savePtoEntries(entries);
      ptoSelectedDays = [];
      renderPto();
    }

    function renderPtoHistory() {
      const entries = getPtoEntries().sort((a, b) => b.date.localeCompare(a.date));
      const container = document.getElementById('ptoHistory');

      if (entries.length === 0) {
        container.innerHTML = `
          <div class="pto-empty-state">
            <div class="pto-empty-state-icon">🏖️</div>
            <div class="pto-empty-state-title">No PTO taken yet</div>
            <div class="pto-empty-state-text">Select days on the calendar above to request time off, or add past entries manually.</div>
          </div>
        `;
        return;
      }

      container.innerHTML = entries.map(e => `
        <div class="pto-history-item">
          <div class="pto-history-date">${formatPtoDate(e.date)}</div>
          <span class="pto-history-type">${e.type || 'vacation'}</span>
          <div class="pto-history-actions">
            <button class="btn-icon danger" onclick="deletePtoEntry('${e.id}')" title="Delete">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    async function deletePtoEntry(id) {
      if (!await showConfirm('Delete PTO Entry', 'Remove this PTO entry from your history?', { okText: 'Delete', danger: true })) return;
      savePtoEntries(getPtoEntries().filter(e => e.id !== id));
      renderPto();
    }

    function addManualPtoEntry() {
      const date = document.getElementById('ptoManualDate').value;
      const type = document.getElementById('ptoManualType').value;
      const notes = document.getElementById('ptoManualNotes').value.trim();

      if (!date) {
        showToast('Please select a date', 'error');
        return;
      }

      const entries = getPtoEntries();
      if (entries.find(e => e.date === date)) {
        showToast('This date is already logged', 'error');
        return;
      }

      entries.push({
        id: Date.now().toString(),
        date,
        type,
        notes,
        confirmedAt: new Date().toISOString(),
        manual: true
      });

      savePtoEntries(entries);
      closeModal('ptoManualEntryModal');
      document.getElementById('ptoManualDate').value = '';
      document.getElementById('ptoManualNotes').value = '';
      renderPto();
    }

    function exportPtoData() {
      const data = {
        settings: getPtoSettings(),
        entries: getPtoEntries(),
        holidays: getPtoHolidays(),
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pto-export-${getDateKey(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportHolidayData() {
      const holidays = getPtoHolidays();
      const blob = new Blob([JSON.stringify(holidays, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `holidays-${getDateKey(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importHolidayData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Support both array format (just holidays) and object format (legacy full PTO export)
          let holidays;
          if (Array.isArray(data)) {
            holidays = data;
          } else if (data.holidays && Array.isArray(data.holidays)) {
            holidays = data.holidays;
          } else {
            showToast('Invalid format. Expected an array of holidays.', 'error');
            return;
          }

          // Validate entries have date and name
          const valid = holidays.every(h => h.date && h.name);
          if (!valid) {
            showToast('Each holiday must have a date and name.', 'error');
            return;
          }

          const merge = await showConfirm('Import Holidays', `Found ${holidays.length} holidays. Replace your current holidays?`, { okText: 'Replace' });
          if (merge) {
            savePtoHolidays(holidays);
            renderPto();
            showToast('Holidays imported successfully!', 'success');
          }
        } catch (err) {
          showToast('Error importing: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function importPtoData(event) {
      // Legacy import - redirect to holiday import
      importHolidayData(event);
    }

    /* ── Holiday Management ── */

    function saveNewHoliday() {
      const date = document.getElementById('addHolidayDate').value;
      const name = document.getElementById('addHolidayName').value.trim();
      if (!date || !name) { showToast('Date and name are required.', 'error'); return; }

      const holidays = getPtoHolidays();
      const editIdx = window._editHolidayIdx;

      if (editIdx !== undefined && editIdx !== null) {
        // Edit mode — update existing
        holidays[editIdx] = { date, name, note: document.getElementById('addHolidayNote').value.trim().toUpperCase() };
        window._editHolidayIdx = null;
      } else {
        // Add mode
        if (holidays.find(h => h.date === date)) {
          showToast('A holiday already exists on this date.', 'error');
          return;
        }
        holidays.push({ date, name, note: document.getElementById('addHolidayNote').value.trim().toUpperCase() });
      }

      holidays.sort((a, b) => a.date.localeCompare(b.date));
      savePtoHolidays(holidays);
      closeModal('addHolidayModal');
      document.getElementById('addHolidayDate').value = '';
      document.getElementById('addHolidayName').value = '';
      document.getElementById('addHolidayNote').value = '';
      renderPto();
    }

    function editSingleHoliday(idx) {
      const holidays = getPtoHolidays();
      const h = holidays[idx];
      if (!h) return;
      document.getElementById('addHolidayDate').value = h.date;
      document.getElementById('addHolidayName').value = h.name;
      document.getElementById('addHolidayNote').value = h.note || '';
      document.getElementById('addHolidayTitle').textContent = 'Edit Holiday';
      document.getElementById('addHolidaySaveBtn').textContent = 'Save Changes';
      window._editHolidayIdx = idx;
      openModal('addHolidayModal');
    }

    async function deleteSingleHoliday(idx) {
      const holidays = getPtoHolidays();
      const h = holidays[idx];
      if (!h) return;
      const ok = await showConfirm('Delete Holiday', `Remove "${h.name}" from your holidays?`, { okText: 'Delete', danger: true });
      if (!ok) return;
      holidays.splice(idx, 1);
      savePtoHolidays(holidays);
      renderPto();
    }

    function renderEditHolidays() {
      const holidays = getPtoHolidays();
      document.getElementById('editHolidaysList').innerHTML = holidays.map((h, idx) => `
        <div class="edit-holiday-row" data-idx="${idx}">
          <input type="date" class="edit-holiday-date" value="${h.date}">
          <input type="text" class="edit-holiday-name" value="${esc(h.name)}" placeholder="Holiday name">
          <input type="text" class="edit-holiday-note" value="${esc(h.note || '')}" placeholder="Note">
          <button class="btn-icon danger" onclick="removeEditHolidayRow(this)" title="Delete"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
        </div>
      `).join('') || '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:0.85rem;">No holidays configured</div>';
    }

    function removeEditHolidayRow(btn) {
      const row = btn.closest('.edit-holiday-row');
      row.remove();
    }

    function saveAllHolidayEdits() {
      const rows = document.querySelectorAll('#editHolidaysList .edit-holiday-row');
      const holidays = [];
      let hasError = false;

      rows.forEach(row => {
        const date = row.querySelector('.edit-holiday-date').value;
        const name = row.querySelector('.edit-holiday-name').value.trim();
        const note = row.querySelector('.edit-holiday-note').value.trim().toUpperCase();
        if (!date || !name) { hasError = true; return; }
        holidays.push({ date, name, note });
      });

      if (hasError) { showToast('Each holiday needs a date and name.', 'error'); return; }

      holidays.sort((a, b) => a.date.localeCompare(b.date));
      savePtoHolidays(holidays);
      closeModal('editHolidaysModal');
      renderPto();
    }

    function formatPtoDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });
    }

    function formatPtoDateLong(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const month = date.toLocaleDateString('en-US', { month: 'long' });
      const day = date.getDate();
      const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
      return `${month} ${day} (${weekday})`;
    }

    function formatPtoDateShort(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    /* ══════════════════════════════════
       EXPORT / IMPORT
       ══════════════════════════════════ */
    function exportData() {
      const data = { 
        version: 4, 
        categories: getCategories(), 
        entries: getEntries(), 
        tasks: getTasks(), 
        notes: getNotes(),
        pto: {
          settings: getPtoSettings(),
          entries: getPtoEntries(),
          holidays: getPtoHolidays()
        },
        exportedAt: new Date().toISOString() 
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `workbench-export-${getDateKey(new Date())}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          const hasEntries = data.entries && Array.isArray(data.entries);
          const hasTasks = data.tasks && Array.isArray(data.tasks);
          const hasNotes = data.notes && typeof data.notes === 'object';
          const hasPto = data.pto && typeof data.pto === 'object';
          if (!hasEntries && !hasTasks && !hasNotes && !hasPto) { showToast('Invalid file: no data found', 'error'); return; }

          const notesCount = hasNotes ? Object.keys(data.notes).length : 0;
          const ptoCount = hasPto && data.pto.entries ? data.pto.entries.length : 0;
          const merge = await showConfirm('Import Data', `Found ${hasEntries ? data.entries.length : 0} time entries, ${hasTasks ? data.tasks.length : 0} tasks, ${notesCount} notes, ${ptoCount} PTO entries. Merge with existing data?`, { okText: 'Merge', cancelText: 'Replace All' });

          if (merge) {
            if (hasEntries) { const ex = getEntries(); const ids = new Set(ex.map(e=>e.id)); localStorage.setItem('wb_timeEntries', JSON.stringify([...ex, ...data.entries.filter(e=>!ids.has(e.id))])); }
            if (hasTasks) { const ex = getTasks(); const ids = new Set(ex.map(t=>t.id)); localStorage.setItem('wb_tasks', JSON.stringify([...ex, ...data.tasks.filter(t=>!ids.has(t.id))])); }
            if (data.categories) localStorage.setItem('wb_categories', JSON.stringify([...new Set([...getCategories(), ...data.categories])]));
            if (hasNotes) {
              const existing = getNotes();
              Object.entries(data.notes).forEach(([date, content]) => {
                if (!existing[date]) existing[date] = content;
              });
              saveNotes(existing);
            }
            if (hasPto) {
              if (data.pto.entries) {
                const ex = getPtoEntries();
                const ids = new Set(ex.map(e => e.id));
                savePtoEntries([...ex, ...data.pto.entries.filter(e => !ids.has(e.id))]);
              }
              // For settings and holidays, only import if none exist
              if (data.pto.settings && !getPtoSettings()) storePtoSettings(data.pto.settings);
              if (data.pto.holidays && getPtoHolidays().length === 0) savePtoHolidays(data.pto.holidays);
            }
          } else {
            if (hasEntries) localStorage.setItem('wb_timeEntries', JSON.stringify(data.entries));
            if (hasTasks) localStorage.setItem('wb_tasks', JSON.stringify(data.tasks));
            if (data.categories) localStorage.setItem('wb_categories', JSON.stringify(data.categories));
            if (hasNotes) saveNotes(data.notes);
            if (hasPto) {
              if (data.pto.settings) storePtoSettings(data.pto.settings);
              if (data.pto.entries) savePtoEntries(data.pto.entries);
              if (data.pto.holidays) savePtoHolidays(data.pto.holidays);
            }
          }

          updateCategorySelect(); renderTimeEntries(); renderTasks(); renderNotes();
          showToast('Import complete!', 'success');
        } catch (err) { showToast('Error: ' + err.message, 'error'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    async function clearAllData() {
      const firstConfirm = await showConfirm('Delete All Data', 'This will permanently delete all your time entries, tasks, notes, categories, and PTO data. This cannot be undone.', { okText: 'Delete Everything', danger: true });
      if (!firstConfirm) return;

      const secondConfirm = await showConfirm('Are you sure?', 'This is your last chance to cancel. All data will be permanently lost.', { okText: 'Yes, delete all', danger: true });
      if (!secondConfirm) return;
      
      // Clear all workbench data
      const keysToRemove = [
        'wb_timeEntries',
        'wb_categories', 
        'wb_tasks',
        'wb_notes',
        'wb_runningTimer',
        'wb_ptoSettings',
        'wb_ptoEntries',
        'wb_ptoHolidays',
        'wb_featureToggles'
      ];
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // Close modal and reload
      closeModal('settingsModal');
      location.reload();
    }

    /* ── Migrate old keys ── */
    function migrateOldData() {
      if (localStorage.getItem('timeEntries') && !localStorage.getItem('wb_timeEntries'))
        localStorage.setItem('wb_timeEntries', localStorage.getItem('timeEntries'));
      if (localStorage.getItem('categories') && !localStorage.getItem('wb_categories'))
        localStorage.setItem('wb_categories', localStorage.getItem('categories'));
      if (localStorage.getItem('runningTimer') && !localStorage.getItem('wb_runningTimer'))
        localStorage.setItem('wb_runningTimer', localStorage.getItem('runningTimer'));
    }

    /* ── Init ── */
    let lastKnownDate = getDateKey(new Date());

    function checkDayChange() {
      const currentDate = getDateKey(new Date());
      if (currentDate !== lastKnownDate) {
        lastKnownDate = currentDate;
        timerViewDate = new Date();
        renderTimeEntries();
      }
    }

    /* ══════════════════════════════════
       SEARCH
       ══════════════════════════════════ */
    let searchSelectedIdx = -1;

    function openSearch() {
      document.getElementById('searchOverlay').classList.add('active');
      const input = document.getElementById('globalSearch');
      input.value = '';
      searchSelectedIdx = -1;
      document.getElementById('searchResults').innerHTML = '<div class="search-initial">Type to search your notes</div>';
      setTimeout(() => input.focus(), 50);
    }

    function onSearchInput() {
      const query = document.getElementById('globalSearch').value.trim().toLowerCase();
      const results = document.getElementById('searchResults');
      searchSelectedIdx = -1;
      if (!query || query.length < 2) {
        results.innerHTML = query.length === 0 ? '<div class="search-initial">Type to search your notes</div>' : '';
        return;
      }

      const matches = [];

      // Search notes
      const notes = getNotes();
      Object.entries(notes).forEach(([dateKey, content]) => {
        if (content.toLowerCase().includes(query)) {
          const d = new Date(dateKey + 'T00:00:00');
          const preview = content.substring(0, 100).replace(/\n/g, ' ');
          matches.push({ type: 'Note', title: d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }), meta: preview, action: () => { openNoteEditor(dateKey); closeSearch(); } });
        }
      });

      if (!matches.length) {
        results.innerHTML = '<div class="search-empty">No notes found</div>';
      } else {
        window.searchResults = matches.slice(0, 10).map(m => m.action);
        results.innerHTML = matches.slice(0, 10).map((m, i) => `
          <div class="search-result-item" data-idx="${i}" onclick="searchResults[${i}]()" onmouseenter="highlightSearchResult(${i})">
            <div class="search-result-title">${esc(m.title)}</div>
            <div class="search-result-meta">${esc(m.meta)}</div>
          </div>`).join('');
      }
    }

    function highlightSearchResult(idx) {
      searchSelectedIdx = idx;
      document.querySelectorAll('.search-result-item').forEach((el, i) => {
        el.classList.toggle('active', i === idx);
      });
    }

    function onSearchKeydown(e) {
      const items = document.querySelectorAll('.search-result-item');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        searchSelectedIdx = Math.min(searchSelectedIdx + 1, items.length - 1);
        highlightSearchResult(searchSelectedIdx);
        items[searchSelectedIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        searchSelectedIdx = Math.max(searchSelectedIdx - 1, 0);
        highlightSearchResult(searchSelectedIdx);
        items[searchSelectedIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (searchSelectedIdx >= 0 && window.searchResults && window.searchResults[searchSelectedIdx]) {
          window.searchResults[searchSelectedIdx]();
        }
      }
    }

    function closeSearch() {
      document.getElementById('searchOverlay').classList.remove('active');
      document.getElementById('globalSearch').value = '';
      searchSelectedIdx = -1;
    }

    /* ══════════════════════════════════
       KEYBOARD SHORTCUTS
       ══════════════════════════════════ */
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', e => {
        const mod = e.metaKey || e.ctrlKey;
        if (!mod) return;

        // Block all shortcuts when a modal or search overlay is open
        const modalOpen = document.querySelector('.modal-overlay.active');
        const searchOpen = document.getElementById('searchOverlay').classList.contains('active');
        if (modalOpen || searchOpen) return;

        // Don't intercept when typing in inputs/textareas (except for specific shortcuts)
        const tag = document.activeElement.tagName;
        const inInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

        if (e.key === '/') {
          e.preventDefault();
          openSearch();
        }

        if (inInput) return; // Skip remaining shortcuts if in an input

        const toggles = getFeatureToggles();
        const tabs = ['timer', 'tasks', 'notes', 'pto'];
        const visibleTabs = tabs.filter(t => toggles[t]);

        if (e.key >= '1' && e.key <= '4') {
          const idx = parseInt(e.key) - 1;
          if (visibleTabs[idx]) { e.preventDefault(); switchApp(visibleTabs[idx]); }
        }

        if (e.key === 'k' || e.key === 'K') {
          e.preventDefault();
          switchApp('tasks');
          setTimeout(() => document.getElementById('taskTitle').focus(), 50);
        }

        if (e.key === 'j' || e.key === 'J') {
          e.preventDefault();
          switchApp('notes');
          openNoteEditor();
        }
      });
    }

    /* ══════════════════════════════════
       FEATURE TOGGLES
       ══════════════════════════════════ */
    function switchSettingsTab(tab) {
      document.querySelectorAll('.settings-tab').forEach(t => {
        t.classList.toggle('active', t.getAttribute('onclick') === `switchSettingsTab('${tab}')`);
      });
      document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('settingsPanel-' + tab).classList.add('active');
    }

    const featureMap = {
      timer: { tab: "switchApp('timer')", view: 'view-timer', checkbox: 'featureTimer' },
      tasks: { tab: "switchApp('tasks')", view: 'view-tasks', checkbox: 'featureTasks' },
      notes: { tab: "switchApp('notes')", view: 'view-notes', checkbox: 'featureNotes' },
      pto:   { tab: "switchApp('pto')",   view: 'view-pto',   checkbox: 'featurePto' }
    };

    function getFeatureToggles() {
      return JSON.parse(localStorage.getItem('wb_featureToggles')) || { timer: true, tasks: true, notes: true, pto: true };
    }

    function saveFeatureToggles() {
      const toggles = {};
      for (const [key, val] of Object.entries(featureMap)) {
        toggles[key] = document.getElementById(val.checkbox).checked;
      }
      // Must keep at least one feature on
      const enabledCount = Object.values(toggles).filter(Boolean).length;
      if (enabledCount === 0) {
        showToast('You need at least one feature enabled.', 'error');
        loadFeatureToggles(); // Revert checkboxes
        return;
      }
      localStorage.setItem('wb_featureToggles', JSON.stringify(toggles));
      applyFeatureToggles();
    }

    function loadFeatureToggles() {
      const toggles = getFeatureToggles();
      for (const [key, val] of Object.entries(featureMap)) {
        document.getElementById(val.checkbox).checked = toggles[key];
      }
    }

    function applyFeatureToggles() {
      const toggles = getFeatureToggles();
      const tabs = document.querySelectorAll('.app-tab');

      for (const [key, val] of Object.entries(featureMap)) {
        const tab = document.querySelector(`[onclick="${val.tab}"]`);
        if (tab) tab.style.display = toggles[key] ? '' : 'none';
      }

      // If current active tab is now hidden, switch to first visible
      const activeTab = document.querySelector('.app-tab.active');
      if (activeTab && activeTab.style.display === 'none') {
        const firstVisible = Object.entries(toggles).find(([k, v]) => v);
        if (firstVisible) switchApp(firstVisible[0]);
      }
    }

    function init() {
      migrateOldData();
      if (!localStorage.getItem('wb_categories')) localStorage.setItem('wb_categories', JSON.stringify(defaultCategories));
      const running = localStorage.getItem('wb_runningTimer');
      if (running) {
        const t = JSON.parse(running);
        startTime = new Date(t.startTime);
        document.getElementById('description').value = t.description;
        resumeTimer();
      }
      updateCategorySelect();
      renderTimeEntries();
      renderTasks();
      renderNotes();
      
      // Notes editor input listener
      document.getElementById('notesEditor').addEventListener('input', onNotesInput);

      // Feature toggles
      loadFeatureToggles();
      applyFeatureToggles();

      // Keyboard shortcuts
      setupKeyboardShortcuts();

      // Check for day change every 30 seconds
      setInterval(checkDayChange, 30000);

      // Also check when tab becomes visible again (e.g. switching back after overnight)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) checkDayChange();
      });
    }

    document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', e => { if (e.target === o) { o.classList.remove('active'); if (!document.querySelector('.modal-overlay.active')) document.body.style.overflow = ''; } }); });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') { closeSearch(); document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); document.body.style.overflow = ''; }
      if (e.key === 'Enter' && document.activeElement.id === 'newCategory') addCategory();
      if (e.key === 'Enter' && document.activeElement.id === 'taskTitle') addTask();
    });

    init();
  </script>
</body>
</html>